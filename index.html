<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Drug GI PKPD Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 97%; margin: 0 auto; }
        .header { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .controls { background: white; border-radius: 15px; padding: 20px; height: fit-content; max-height: 90vh; overflow-y: auto; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 5px; }
        .control-group select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        .value { font-size: 0.8rem; color: #666; }
        .drug-tabs { display: flex; margin-bottom: 15px; }
        .drug-tab { flex: 1; padding: 10px; background: #f0f0f0; border: none; cursor: pointer; }
        .drug-tab.active { background: #667eea; color: white; }
        .drug-panel { display: none; }
        .drug-panel.active { display: block; }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { background: white; border-radius: 15px; padding: 20px; }
        .chart-wrapper { height: 300px; margin-bottom: 10px; }
        .chart-info { font-size: 0.8rem; color: #666; background: #f8f8f8; padding: 10px; border-radius: 5px; }
        .interaction-section { background: #fff3cd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .run-button { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 15px; }
        .stats { background: white; border-radius: 15px; padding: 20px; margin-top: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { background: #667eea; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.2rem; font-weight: bold; }
        .stat-label { font-size: 0.8rem; }
        
        /* Responsive adjustments for better screen usage */
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 320px 1fr; }
        }
        
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .charts { grid-template-columns: 1fr; }
        }
        
        @media (min-width: 1800px) {
            .charts { grid-template-columns: 1fr 1fr 1fr; }
            .chart-wrapper { height: 350px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dual Drug GI PKPD Simulator</h1>
        </div>
        
        <div class="main-grid">
            <div class="controls">
                <h3>Parameters</h3>
                
                <div class="drug-tabs">
                    <button class="drug-tab active" onclick="switchTab(1)">Drug A</button>
                    <button class="drug-tab" onclick="switchTab(2)">Drug B</button>
                </div>
                
                <div class="drug-panel active" id="panel1">
                    <div class="control-group">
                        <label><input type="checkbox" id="enabled1" checked onchange="runSim()"> Enable Drug A</label>
                    </div>
                    <div class="control-group">
                        <label>Dose (mg):</label>
                        <input type="range" id="dose1" min="0" max="500" value="50" oninput="updateVal('dose1'); runSim();">
                        <div class="value" id="dose1Val">50 mg</div>
                    </div>
                    <div class="control-group">
                        <label>Admin Time (hrs):</label>
                        <input type="range" id="adminTime1" min="0" max="12" step="0.5" value="0" oninput="updateVal('adminTime1'); runSim();">
                        <div class="value" id="adminTime1Val">0 hrs</div>
                    </div>
                    <div class="control-group">
                        <label>Dosing Interval (hrs):</label>
                        <input type="range" id="interval1" min="0" max="24" step="1" value="0" oninput="updateVal('interval1'); runSim();">
                        <div class="value" id="interval1Val">0 hrs (single dose)</div>
                    </div>
                    <div class="control-group">
                        <label>Number of Doses:</label>
                        <input type="range" id="numDoses1" min="1" max="10" step="1" value="1" oninput="updateVal('numDoses1'); runSim();">
                        <div class="value" id="numDoses1Val">1</div>
                    </div>
                    <div class="control-group">
                        <label>Dissolution Rate:</label>
                        <input type="range" id="dissolution1" min="0.01" max="10" step="0.01" value="0.1" oninput="updateVal('dissolution1'); runSim();">
                        <div class="value" id="dissolution1Val">0.1</div>
                    </div>
                    <div class="control-group">
                        <label>Stomach Absorption:</label>
                        <input type="range" id="stomachAbs1" min="0.01" max="0.5" step="0.01" value="0.05" oninput="updateVal('stomachAbs1'); runSim();">
                        <div class="value" id="stomachAbs1Val">0.05</div>
                    </div>
                    <div class="control-group">
                        <label>Small Intestine Absorption:</label>
                        <input type="range" id="siAbs1" min="0.01" max="0.8" step="0.01" value="0.3" oninput="updateVal('siAbs1'); runSim();">
                        <div class="value" id="siAbs1Val">0.3</div>
                    </div>
                    <div class="control-group">
                        <label>Large Intestine Absorption:</label>
                        <input type="range" id="liAbs1" min="0.01" max="0.3" step="0.01" value="0.1" oninput="updateVal('liAbs1'); runSim();">
                        <div class="value" id="liAbs1Val">0.1</div>
                    </div>
                    <div class="control-group">
                        <label>Stomach Transit:</label>
                        <input type="range" id="stomachTransit1" min="0.01" max="0.5" step="0.01" value="0.2" oninput="updateVal('stomachTransit1'); runSim();">
                        <div class="value" id="stomachTransit1Val">0.2</div>
                    </div>
                    <div class="control-group">
                        <label>Intestine Transit:</label>
                        <input type="range" id="intestineTransit1" min="0.01" max="0.5" step="0.01" value="0.15" oninput="updateVal('intestineTransit1'); runSim();">
                        <div class="value" id="intestineTransit1Val">0.15</div>
                    </div>
                    <div class="control-group">
                        <label>Distribution to Tissue:</label>
                        <input type="range" id="distribution1" min="0.01" max="0.5" step="0.01" value="0.1" oninput="updateVal('distribution1'); runSim();">
                        <div class="value" id="distribution1Val">0.1</div>
                    </div>
                    <div class="control-group">
                        <label>Redistribution from Tissue:</label>
                        <input type="range" id="redistribution1" min="0.01" max="0.3" step="0.01" value="0.05" oninput="updateVal('redistribution1'); runSim();">
                        <div class="value" id="redistribution1Val">0.05</div>
                    </div>
                    <div class="control-group">
                        <label>Bioavailability:</label>
                        <input type="range" id="bioavailability1" min="0.01" max="1.0" step="0.01" value="0.7" oninput="updateVal('bioavailability1'); runSim();">
                        <div class="value" id="bioavailability1Val">0.7</div>
                    </div>
                    <div class="control-group">
                        <label>EC50:</label>
                        <input type="range" id="ec501" min="0.1" max="10" step="0.1" value="2.0" oninput="updateVal('ec501'); runSim();">
                        <div class="value" id="ec501Val">2.0</div>
                    </div>
                    <div class="control-group">
                        <label>Emax:</label>
                        <input type="range" id="emax1" min="-100" max="100" step="5" value="-50" oninput="updateVal('emax1'); runSim();">
                        <div class="value" id="emax1Val">-50</div>
                    </div>
                    <div class="control-group">
                        <label>Half-life (hrs):</label>
                        <input type="range" id="halflife1" min="0.5" max="24" step="0.5" value="6.9" oninput="updateVal('halflife1'); runSim();">
                        <div class="value" id="halflife1Val">6.9 hrs</div>
                    </div>
                </div>
                
                <div class="drug-panel" id="panel2">
                    <div class="control-group">
                        <label><input type="checkbox" id="enabled2" checked onchange="runSim()"> Enable Drug B</label>
                    </div>
                    <div class="control-group">
                        <label>Dose (mg):</label>
                        <input type="range" id="dose2" min="0" max="500" value="75" oninput="updateVal('dose2'); runSim();">
                        <div class="value" id="dose2Val">75 mg</div>
                    </div>
                    <div class="control-group">
                        <label>Admin Time (hrs):</label>
                        <input type="range" id="adminTime2" min="0" max="12" step="0.5" value="2" oninput="updateVal('adminTime2'); runSim();">
                        <div class="value" id="adminTime2Val">2 hrs</div>
                    </div>
                    <div class="control-group">
                        <label>Dosing Interval (hrs):</label>
                        <input type="range" id="interval2" min="0" max="24" step="1" value="0" oninput="updateVal('interval2'); runSim();">
                        <div class="value" id="interval2Val">0 hrs (single dose)</div>
                    </div>
                    <div class="control-group">
                        <label>Number of Doses:</label>
                        <input type="range" id="numDoses2" min="1" max="10" step="1" value="1" oninput="updateVal('numDoses2'); runSim();">
                        <div class="value" id="numDoses2Val">1</div>
                    </div>
                    <div class="control-group">
                        <label>Dissolution Rate:</label>
                        <input type="range" id="dissolution2" min="0.01" max="0.5" step="0.01" value="0.15" oninput="updateVal('dissolution2'); runSim();">
                        <div class="value" id="dissolution2Val">0.15</div>
                    </div>
                    <div class="control-group">
                        <label>Stomach Absorption:</label>
                        <input type="range" id="stomachAbs2" min="0.01" max="0.5" step="0.01" value="0.03" oninput="updateVal('stomachAbs2'); runSim();">
                        <div class="value" id="stomachAbs2Val">0.03</div>
                    </div>
                    <div class="control-group">
                        <label>Small Intestine Absorption:</label>
                        <input type="range" id="siAbs2" min="0.01" max="0.8" step="0.01" value="0.4" oninput="updateVal('siAbs2'); runSim();">
                        <div class="value" id="siAbs2Val">0.4</div>
                    </div>
                    <div class="control-group">
                        <label>Large Intestine Absorption:</label>
                        <input type="range" id="liAbs2" min="0.01" max="0.3" step="0.01" value="0.08" oninput="updateVal('liAbs2'); runSim();">
                        <div class="value" id="liAbs2Val">0.08</div>
                    </div>
                    <div class="control-group">
                        <label>Stomach Transit:</label>
                        <input type="range" id="stomachTransit2" min="0.01" max="0.5" step="0.01" value="0.2" oninput="updateVal('stomachTransit2'); runSim();">
                        <div class="value" id="stomachTransit2Val">0.2</div>
                    </div>
                    <div class="control-group">
                        <label>Intestine Transit:</label>
                        <input type="range" id="intestineTransit2" min="0.01" max="0.5" step="0.01" value="0.15" oninput="updateVal('intestineTransit2'); runSim();">
                        <div class="value" id="intestineTransit2Val">0.15</div>
                    </div>
                    <div class="control-group">
                        <label>Distribution to Tissue:</label>
                        <input type="range" id="distribution2" min="0.01" max="0.5" step="0.01" value="0.1" oninput="updateVal('distribution2'); runSim();">
                        <div class="value" id="distribution2Val">0.1</div>
                    </div>
                    <div class="control-group">
                        <label>Redistribution from Tissue:</label>
                        <input type="range" id="redistribution2" min="0.01" max="0.3" step="0.01" value="0.05" oninput="updateVal('redistribution2'); runSim();">
                        <div class="value" id="redistribution2Val">0.05</div>
                    </div>
                    <div class="control-group">
                        <label>Bioavailability:</label>
                        <input type="range" id="bioavailability2" min="0.01" max="1.0" step="0.01" value="0.8" oninput="updateVal('bioavailability2'); runSim();">
                        <div class="value" id="bioavailability2Val">0.8</div>
                    </div>
                    <div class="control-group">
                        <label>Elimination Rate:</label>
                        <input type="range" id="elim2" min="0.01" max="0.3" step="0.01" value="0.08" oninput="updateVal('elim2'); runSim();">
                        <div class="value" id="elim2Val">0.08</div>
                    </div>
                    <div class="control-group">
                        <label>EC50:</label>
                        <input type="range" id="ec502" min="0.1" max="10" step="0.1" value="5.0" oninput="updateVal('ec502'); runSim();">
                        <div class="value" id="ec502Val">5.0</div>
                    </div>
                    <div class="control-group">
                        <label>Emax:</label>
                        <input type="range" id="emax2" min="-100" max="100" step="5" value="-60" oninput="updateVal('emax2'); runSim();">
                        <div class="value" id="emax2Val">-60</div>
                    </div>
                    <div class="control-group">
                        <label>Half-life (hrs):</label>
                        <input type="range" id="halflife2" min="0.5" max="24" step="0.5" value="8.7" oninput="updateVal('halflife2'); runSim();">
                        <div class="value" id="halflife2Val">8.7 hrs</div>
                    </div>
                </div>
                
                <div class="interaction-section">
                    <h3>Drug Interactions</h3>
                    <div class="control-group">
                        <label>Interaction Type:</label>
                        <select id="interactionType" onchange="runSim()">
                            <option value="additive">Additive</option>
                            <option value="synergistic">Synergistic</option>
                            <option value="antagonistic">Antagonistic</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Interaction Factor:</label>
                        <input type="range" id="interactionFactor" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVal('interactionFactor'); runSim();">
                        <div class="value" id="interactionFactorVal">1.0</div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Baseline Effect:</label>
                    <input type="range" id="baseline" min="50" max="200" step="5" value="120" oninput="updateVal('baseline'); runSim();">
                    <div class="value" id="baselineVal">120</div>
                </div>
                
                <div class="control-group">
                    <label>Target Effect:</label>
                    <input type="range" id="targetEffect" min="50" max="200" step="5" value="90" oninput="updateVal('targetEffect'); runSim();">
                    <div class="value" id="targetEffectVal">90</div>
                </div>
                
                <div class="control-group">
                    <label>Simulation Time (hrs):</label>
                    <input type="range" id="simTime" min="0" max="720" step="6" value="48" oninput="updateVal('simTime'); runSim();">
                    <div class="value" id="simTimeVal">48 hrs</div>
                </div>
                
                <button class="run-button" onclick="runSim()">Run Simulation</button>
            </div>
            
            <div class="charts">
                <div class="chart-container">
                    <h4>Drug Release & Dissolution</h4>
                    <div class="chart-wrapper">
                        <canvas id="chart1"></canvas>
                    </div>
                    <div class="chart-info">Tablet dissolution and dissolved drug profiles</div>
                </div>
                
                <div class="chart-container">
                    <h4>GI Distribution & Plasma</h4>
                    <div class="chart-wrapper">
                        <canvas id="chart2"></canvas>
                    </div>
                    <div class="chart-info">Complete drug journey: GI + plasma + tissue distribution</div>
                </div>
                
                <div class="chart-container">
                    <h4>Combined Pharmacodynamic Effects</h4>
                    <div class="chart-wrapper">
                        <canvas id="chart3"></canvas>
                    </div>
                    <div class="chart-info">Individual and combined drug effects with interactions</div>
                </div>
                
                <div class="chart-container">
                    <h4>Results</h4>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="cmax1">-</div><div class="stat-label">Drug A Cmax</div></div>
                        <div class="stat-card"><div class="stat-value" id="cmax2">-</div><div class="stat-label">Drug B Cmax</div></div>
                        <div class="stat-card"><div class="stat-value" id="tmax1">-</div><div class="stat-label">Drug A Tmax</div></div>
                        <div class="stat-card"><div class="stat-value" id="tmax2">-</div><div class="stat-label">Drug B Tmax</div></div>
                        <div class="stat-card"><div class="stat-value" id="auc1">-</div><div class="stat-label">Drug A AUC</div></div>
                        <div class="stat-card"><div class="stat-value" id="auc2">-</div><div class="stat-label">Drug B AUC</div></div>
                        <div class="stat-card"><div class="stat-value" id="maxEffect">-</div><div class="stat-label">Max Effect</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
var charts = {};

function switchTab(n) {
    document.querySelectorAll('.drug-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.drug-panel').forEach(function(p) { p.classList.remove('active'); });
    document.querySelector('.drug-tab:nth-child(' + n + ')').classList.add('active');
    document.getElementById('panel' + n).classList.add('active');
}

function updateVal(id) {
    var el = document.getElementById(id);
    var val = document.getElementById(id + 'Val');
    if (el && val) {
        var v = el.value;
        if (id.includes('dose')) v += ' mg';
        else if (id.includes('Time') || id.includes('halflife')) v += ' hrs';
        else if (id.includes('interval')) {
            if (parseFloat(v) === 0) v += ' hrs (single dose)';
            else v += ' hrs';
        }
        val.textContent = v;
    }
}

function getVal(id) {
    var el = document.getElementById(id);
    return el ? parseFloat(el.value) : 0;
}

function getCheck(id) {
    var el = document.getElementById(id);
    return el ? el.checked : false;
}

function getSelect(id) {
    var el = document.getElementById(id);
    return el ? el.value : '';
}

function calculateElimFromHalflife(halflife) {
    return Math.log(2) / halflife;
}

function combineEffects(e1, e2, type, factor) {
    switch (type) {
        case 'additive': return e1 + e2;
        case 'synergistic': return (e1 + e2) * factor;
        case 'antagonistic': return (e1 + e2) / factor;
        default: return e1 + e2;
    }
}

function simulate() {
    var data = [];
    var dt = 0.1;
    var simTime = getVal('simTime');
    var steps = Math.floor(simTime / dt);
    var baseline = getVal('baseline');
    var interactionType = getSelect('interactionType') || 'additive';
    var interactionFactor = getVal('interactionFactor') || 1.0;
    
    var drug1Params = {
        enabled: getCheck('enabled1'),
        dose: getVal('dose1'),
        adminTime: getVal('adminTime1'),
        interval: getVal('interval1'),
        numDoses: getVal('numDoses1'),
        elim: calculateElimFromHalflife(getVal('halflife1') || 6.9)
    };
    
    var drug2Params = {
        enabled: getCheck('enabled2'),
        dose: getVal('dose2'),
        adminTime: getVal('adminTime2'),
        interval: getVal('interval2'),
        numDoses: getVal('numDoses2'),
        elim: calculateElimFromHalflife(getVal('halflife2') || 8.7)
    };
    
    var drug1DoseTimes = [];
    var drug2DoseTimes = [];
    
    if (drug1Params.enabled) {
        for (var d = 0; d < drug1Params.numDoses; d++) {
            var doseTime = drug1Params.adminTime + (d * drug1Params.interval);
            if (doseTime <= simTime) drug1DoseTimes.push(Math.round(doseTime * 10) / 10);
        }
    }
    
    if (drug2Params.enabled) {
        for (var d = 0; d < drug2Params.numDoses; d++) {
            var doseTime = drug2Params.adminTime + (d * drug2Params.interval);
            if (doseTime <= simTime) drug2DoseTimes.push(Math.round(doseTime * 10) / 10);
        }
    }
    
    var drug1 = { tablet: 0, stomach: 0, si: 0, li: 0, plasma: 0, tissue: 0 };
    var drug2 = { tablet: 0, stomach: 0, si: 0, li: 0, plasma: 0, tissue: 0 };
    
    for (var i = 0; i <= steps; i++) {
        var time = i * dt;
        var currentTime = Math.round(time * 10) / 10;
        
        if (drug1DoseTimes.includes(currentTime)) {
            drug1.tablet += drug1Params.dose;
        }
        if (drug2DoseTimes.includes(currentTime)) {
            drug2.tablet += drug2Params.dose;
        }
        
        if (i % 10 === 0) {
            var e1 = drug1Params.enabled ? calcEffect(drug1.plasma, getVal('ec501'), getVal('emax1')) : 0;
            var e2 = drug2Params.enabled ? calcEffect(drug2.plasma, getVal('ec502'), getVal('emax2')) : 0;
            var combinedE = combineEffects(e1, e2, interactionType, interactionFactor);
            
            data.push({
                time: currentTime,
                drug1: JSON.parse(JSON.stringify(drug1)),
                drug2: JSON.parse(JSON.stringify(drug2)),
                effect1: e1,
                effect2: e2,
                combinedEffect: baseline + combinedE,
                dissolvedDrug1: (drug1Params.numDoses * drug1Params.dose) - drug1.tablet,
                dissolvedDrug2: (drug2Params.numDoses * drug2Params.dose) - drug2.tablet
            });
        }
        
        if (drug1.tablet > 0 || drug1.stomach > 0 || drug1.si > 0 || drug1.li > 0 || drug1.plasma > 0) {
            updateDrug(drug1, 1, dt, drug1Params.elim);
        }
        if (drug2.tablet > 0 || drug2.stomach > 0 || drug2.si > 0 || drug2.li > 0 || drug2.plasma > 0) {
            updateDrug(drug2, 2, dt, drug2Params.elim);
        }
    }
    
    return data;
}

function updateDrug(drug, drugNum, dt, elimRate) {
    var dissolution = Math.max(0, drug.tablet) * getVal('dissolution' + drugNum) * dt;
    var stomachAbs = Math.max(0, drug.stomach) * getVal('stomachAbs' + drugNum) * dt;
    var siAbs = Math.max(0, drug.si) * getVal('siAbs' + drugNum) * dt;
    var liAbs = Math.max(0, drug.li) * getVal('liAbs' + drugNum) * dt;
    var stomachTransit = Math.max(0, drug.stomach) * getVal('stomachTransit' + drugNum) * dt;
    var intestineTransit = Math.max(0, drug.si) * getVal('intestineTransit' + drugNum) * dt;
    var distribution = Math.max(0, drug.plasma) * getVal('distribution' + drugNum) * dt;
    var redistribution = Math.max(0, drug.tissue) * getVal('redistribution' + drugNum) * dt;
    var elimination = Math.max(0, drug.plasma) * elimRate * dt;
    
    // Apply bioavailability to absorbed drug amounts
    var bioavailability = getVal('bioavailability' + drugNum);
    var bioavailableStomachAbs = stomachAbs * bioavailability;
    var bioavailableSiAbs = siAbs * bioavailability;
    var bioavailableLiAbs = liAbs * bioavailability;
    
    drug.tablet = Math.max(0, drug.tablet - dissolution);
    drug.stomach = Math.max(0, drug.stomach + dissolution - stomachAbs - stomachTransit);
    drug.si = Math.max(0, drug.si + stomachTransit - siAbs - intestineTransit);
    drug.li = Math.max(0, drug.li + intestineTransit - liAbs);
    drug.plasma = Math.max(0, drug.plasma + bioavailableStomachAbs + bioavailableSiAbs + bioavailableLiAbs - elimination - distribution + redistribution);
    drug.tissue = Math.max(0, drug.tissue + distribution - redistribution);
}

function calcEffect(conc, ec50, emax) {
    if (conc <= 0) return 0;
    return (emax * conc) / (ec50 + conc);
}

function calculateStats(data) {
    if (!data.length) return {cmax1: 0, cmax2: 0, tmax1: 0, tmax2: 0, auc1: 0, auc2: 0, maxEffect: 0, effectDuration: 0};
    
    var plasma1 = data.map(function(d) { return d.drug1.plasma; });
    var plasma2 = data.map(function(d) { return d.drug2.plasma; });
    var effects = data.map(function(d) { return Math.abs(d.combinedEffect - getVal('baseline')); });
    
    var cmax1 = Math.max.apply(Math, plasma1);
    var cmax2 = Math.max.apply(Math, plasma2);
    var tmax1 = plasma1.length > 0 ? data[plasma1.indexOf(cmax1)].time : 0;
    var tmax2 = plasma2.length > 0 ? data[plasma2.indexOf(cmax2)].time : 0;
    
    var auc1 = 0, auc2 = 0;
    for (var i = 1; i < data.length; i++) {
        var dt = data[i].time - data[i-1].time;
        auc1 += (plasma1[i] + plasma1[i-1]) * dt / 2;
        auc2 += (plasma2[i] + plasma2[i-1]) * dt / 2;
    }
    
    var maxEffect = Math.max.apply(Math, effects);
    var effectDuration = data.filter(function(d) { 
        return Math.abs(d.combinedEffect - getVal('baseline')) > maxEffect * 0.1; 
    }).length * 0.1;
    
    return {
        cmax1: cmax1,
        cmax2: cmax2,
        tmax1: tmax1,
        tmax2: tmax2,
        auc1: auc1,
        auc2: auc2,
        maxEffect: maxEffect,
        effectDuration: effectDuration
    };
}

function setupCharts() {
    var opts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: 'Time (hrs)' } },
            y: { title: { display: true, text: 'Amount/Effect' } }
        }
    };
    
    charts.release = new Chart(document.getElementById('chart1').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Drug A Tablet', data: [], borderColor: '#e74c3c', borderWidth: 3, fill: false, pointRadius: 0 },
            { label: 'Drug B Tablet', data: [], borderColor: '#3498db', borderWidth: 3, fill: false, pointRadius: 0 },
            { label: 'Drug A Dissolved', data: [], borderColor: '#e74c3c', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 },
            { label: 'Drug B Dissolved', data: [], borderColor: '#3498db', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 }
        ]},
        options: opts
    });
    
    charts.gi = new Chart(document.getElementById('chart2').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Drug A Stomach', data: [], borderColor: '#e74c3c', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug A Small Intestine', data: [], borderColor: '#c0392b', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug A Large Intestine', data: [], borderColor: '#a93226', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug A Plasma', data: [], borderColor: '#e74c3c', borderWidth: 4, fill: false, pointRadius: 0 },
            { label: 'Drug A Tissue', data: [], borderColor: '#e74c3c', borderWidth: 2, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'Drug B Stomach', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Small Intestine', data: [], borderColor: '#2980b9', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Large Intestine', data: [], borderColor: '#1f618d', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Plasma', data: [], borderColor: '#3498db', borderWidth: 4, fill: false, pointRadius: 0 },
            { label: 'Drug B Tissue', data: [], borderColor: '#3498db', borderWidth: 2, borderDash: [3, 3], fill: false, pointRadius: 0 }
        ]},
        options: opts
    });
    
    var effectOpts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: 'Time (hrs)' } },
            y: { title: { display: true, text: 'Effect' } }
        }
    };
    
    charts.effects = new Chart(document.getElementById('chart3').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Drug A Effect', data: [], borderColor: '#e74c3c', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Effect', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Combined Effect', data: [], borderColor: '#9b59b6', borderWidth: 4, fill: false, pointRadius: 0 },
            { label: 'Baseline', data: [], borderColor: '#95a5a6', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 },
            { label: 'Target Effect', data: [], borderColor: '#27ae60', borderWidth: 2, borderDash: [10, 3], fill: false, pointRadius: 0 }
        ]},
        options: effectOpts
    });
}

function runSim() {
    try {
        var data = simulate();
        if (!data.length) return;
        
        var times = data.map(function(d) { return d.time; });
        var baseline = getVal('baseline');
        var target = getVal('targetEffect');
        var stats = calculateStats(data);
        
        var allEffects = [];
        data.forEach(function(d) {
            allEffects.push(baseline + d.effect1);
            allEffects.push(baseline + d.effect2);
            allEffects.push(d.combinedEffect);
        });
        allEffects.push(baseline);
        allEffects.push(target);
        
        var minEffect = Math.min.apply(Math, allEffects);
        var maxEffect = Math.max.apply(Math, allEffects);
        var range = maxEffect - minEffect;
        var padding = Math.max(10, range * 0.1);
        
        charts.effects.options.scales.y.min = minEffect - padding;
        charts.effects.options.scales.y.max = maxEffect + padding;
        
        charts.release.data.labels = times;
        charts.release.data.datasets[0].data = data.map(function(d) { return d.drug1.tablet; });
        charts.release.data.datasets[1].data = data.map(function(d) { return d.drug2.tablet; });
        charts.release.data.datasets[2].data = data.map(function(d) { return d.dissolvedDrug1; });
        charts.release.data.datasets[3].data = data.map(function(d) { return d.dissolvedDrug2; });
        charts.release.update();
        
        charts.gi.data.labels = times;
        charts.gi.data.datasets[0].data = data.map(function(d) { return d.drug1.stomach; });
        charts.gi.data.datasets[1].data = data.map(function(d) { return d.drug1.si; });
        charts.gi.data.datasets[2].data = data.map(function(d) { return d.drug1.li; });
        charts.gi.data.datasets[3].data = data.map(function(d) { return d.drug1.plasma; });
        charts.gi.data.datasets[4].data = data.map(function(d) { return d.drug1.tissue; });
        charts.gi.data.datasets[5].data = data.map(function(d) { return d.drug2.stomach; });
        charts.gi.data.datasets[6].data = data.map(function(d) { return d.drug2.si; });
        charts.gi.data.datasets[7].data = data.map(function(d) { return d.drug2.li; });
        charts.gi.data.datasets[8].data = data.map(function(d) { return d.drug2.plasma; });
        charts.gi.data.datasets[9].data = data.map(function(d) { return d.drug2.tissue; });
        charts.gi.update();
        
        charts.effects.data.labels = times;
        charts.effects.data.datasets[0].data = data.map(function(d) { return baseline + d.effect1; });
        charts.effects.data.datasets[1].data = data.map(function(d) { return baseline + d.effect2; });
        charts.effects.data.datasets[2].data = data.map(function(d) { return d.combinedEffect; });
        charts.effects.data.datasets[3].data = data.map(function(d) { return baseline; });
        charts.effects.data.datasets[4].data = data.map(function(d) { return target; });
        charts.effects.update();
        
        document.getElementById('cmax1').textContent = stats.cmax1.toFixed(2);
        document.getElementById('cmax2').textContent = stats.cmax2.toFixed(2);
        document.getElementById('tmax1').textContent = stats.tmax1.toFixed(1);
        document.getElementById('tmax2').textContent = stats.tmax2.toFixed(1);
        document.getElementById('auc1').textContent = stats.auc1.toFixed(1);
        document.getElementById('auc2').textContent = stats.auc2.toFixed(1);
        document.getElementById('maxEffect').textContent = stats.maxEffect.toFixed(1);
    } catch (error) {
        console.error('Error in runSim:', error);
    }
}

window.onload = function() {
    var controls = ['dose1', 'dose2', 'adminTime1', 'adminTime2', 'interval1', 'interval2', 
                   'numDoses1', 'numDoses2', 'dissolution1', 'dissolution2',
                   'stomachAbs1', 'stomachAbs2', 'siAbs1', 'siAbs2', 'liAbs1', 'liAbs2',
                   'stomachTransit1', 'stomachTransit2', 'intestineTransit1', 'intestineTransit2',
                   'distribution1', 'distribution2', 'redistribution1', 'redistribution2',
                   'bioavailability1', 'bioavailability2',
                   'elim2', 'ec501', 'ec502', 'emax1', 'emax2', 'halflife1', 'halflife2',
                   'baseline', 'targetEffect', 'simTime', 'interactionFactor'];
    
    controls.forEach(function(id) { updateVal(id); });
    
    setupCharts();
    runSim();
};
</script>
</body>
</html>
                    
