<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Drug GI PKPD Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 97%; margin: 0 auto; }
        .header { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .controls { background: white; border-radius: 15px; padding: 20px; height: fit-content; max-height: 90vh; overflow-y: auto; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 5px; }
        .control-group select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 5px; }
        .value { font-size: 0.8rem; color: #666; }
        .drug-tabs { display: flex; margin-bottom: 15px; }
        .drug-tab { flex: 1; padding: 10px; background: #f0f0f0; border: none; cursor: pointer; }
        .drug-tab.active { background: #667eea; color: white; }
        .drug-panel { display: none; }
        .drug-panel.active { display: block; }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { background: white; border-radius: 15px; padding: 20px; }
        .chart-wrapper { height: 300px; margin-bottom: 10px; position: relative; }
        .chart-info { font-size: 0.8rem; color: #666; background: #f8f8f8; padding: 10px; border-radius: 5px; }
        
        /* Collapsible section styles */
        .interaction-section, .target-section, .dosing-section, .absorption-section, .transit-section { 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
        }
        .interaction-section { background: #fff3cd; }
        .target-section { background: #e8f5e8; }
        .dosing-section { background: #e3f2fd; }
        .absorption-section { background: #e1f5fe; }
        .transit-section { background: #e8f4fd; }
        
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 15px 0 !important;
            user-select: none;
        }
        .collapsible-header:hover {
            opacity: 0.8;
        }
        .collapse-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0 !important;
        }
        
        .target-section h4, .dosing-section h4, .absorption-section h4, .transit-section h4 { 
            margin-top: 0; 
        }
        .target-section h4 { color: #2d5016; }
        .dosing-section h4 { color: #1565c0; }
        .absorption-section h4 { color: #0277bd; }
        .transit-section h4 { color: #1e88e5; }
        
        .run-button { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .stat-card { color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-card.drug-a { background: #27ae60; }
        .stat-card.drug-b { background: #3498db; }
        .stat-card.combined { background: #9b59b6; }
        .stat-card.assessment { background: #2c3e50; }
        .stat-card.assessment.pass { background: #27ae60; }
        .stat-card.assessment.fail { background: #e74c3c; }
        .stat-value { font-size: 1.2rem; font-weight: bold; }
        .stat-label { font-size: 0.8rem; }
        .assessment-feedback { margin-top: 15px; padding: 10px; border-radius: 5px; font-size: 0.9rem; }
        
        /* Max effects grid under PD chart */
        .max-effects-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .max-effect-card { 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .max-effect-card.drug-a { background: #27ae60; }
        .max-effect-card.drug-b { background: #3498db; }
        .max-effect-card.combined { background: #9b59b6; }
        .max-effect-value { font-size: 1.1rem; font-weight: bold; margin-bottom: 4px; }
        .max-effect-label { font-size: 0.75rem; }
        
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 320px 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .charts { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (min-width: 1400px) {
            .chart-wrapper { height: 350px; }
        }

/* Modal styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 1000px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.close {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.drug-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.drug-table th,
.drug-table td {
    border: 1px solid #ddd;
    padding: 12px 8px;
    text-align: left;
    font-size: 0.9rem;
}

.drug-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
}

.drug-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.drug-table tr:hover {
    background-color: #e8f4fd;
}

.select-drug-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
}

.select-drug-btn:hover {
    background: #5a6fd8;
}

.dose-input, .dissolution-input {
    width: 80px;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 0.8rem;
}

        .drug-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.drug-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: 1px solid #5a6fd8;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.85rem;
}

.drug-table td {
    border: 1px solid #ddd;
    padding: 10px 8px;
    text-align: center;
    font-size: 0.9rem;
}

.drug-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.drug-table tr:hover {
    background-color: #e3f2fd;
    transition: background-color 0.2s ease;
}

.dose-input, .dissolution-input {
    width: 70px;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.85rem;
    text-align: center;
}

.dose-input:focus, .dissolution-input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
}

.select-drug-btn {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.select-drug-btn:hover {
    background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

   /* Enhanced modal styles */
.config-section {
    padding: 10px;
}

.config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin: 20px 0;
}

.config-group {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.config-group label {
    font-weight: bold;
    font-size: 1rem;
    color: #333;
    display: block;
    margin-bottom: 15px;
}

.option-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.option-btn {
    background: white;
    border: 2px solid #ddd;
    border-radius: 6px;
    padding: 10px 8px;
    cursor: pointer;
    font-size: 0.9rem;
    text-align: center;
    transition: all 0.2s ease;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.option-btn:hover {
    border-color: #667eea;
    background: #f0f4ff;
}

.option-btn.selected {
    background: #667eea;
    border-color: #667eea;
    color: white;
    font-weight: bold;
}

.selected-value {
    font-size: 0.9rem;
    color: #666;
    font-style: italic;
    padding: 8px;
    background: #e8f4fd;
    border-radius: 4px;
    text-align: center;
}

.config-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.cancel-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
}

.cancel-btn:hover {
    background: #5a6268;
}

.choose-drug-btn {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
}

.choose-drug-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.choose-drug-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Button state styles */
.load-button {
    transition: background 0.3s ease;
}

.load-button.not-loaded {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
}

.load-button.not-loaded:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
}

.load-button.loaded {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
}

.load-button.loaded:hover {
    background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
}

/* Update table styling for comma-separated values */
.values-list {
    font-size: 0.8rem;
    line-height: 1.3;
    max-width: 120px;
    word-wrap: break-word;
}

@media (max-width: 768px) {
    .config-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}     


/* Scenario modal styles */
.scenario-modal {
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}

.scenario-modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 15px;
    width: 85%;
    max-width: 800px;
    max-height: 75vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.scenario-modal-header {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%);
    color: #2d5016;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #27ae60;
}

.scenario-modal-header h3 {
    margin: 0;
    font-size: 1.3rem;
}

.scenario-modal-body {
    padding: 25px;
    max-height: 55vh;
    overflow-y: auto;
    line-height: 1.6;
}

.scenario-content {
    font-size: 1rem;
    color: #333;
    line-height: 1.6;
}

.scenario-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 0.9rem;
}

.scenario-content table, 
.scenario-content th, 
.scenario-content td {
    border: 1px solid #ddd;
}

.scenario-content th {
    background-color: #f8f9fa;
    font-weight: bold;
    padding: 12px 8px;
    text-align: left;
}

.scenario-content td {
    padding: 10px 8px;
    vertical-align: top;
}

.scenario-content td:first-child {
    width: 30%;
}

.scenario-content td:nth-child(2) {
    width: 70%;
}

.scenario-content tr:nth-child(even) {
    background-color: #f9f9f9;
}

.scenario-content tr:hover {
    background-color: #e8f4fd;
}

.scenario-content p {
    margin: 10px 0;
}

.scenario-content h1, 
.scenario-content h2, 
.scenario-content h3 {
    color: #2d5016;
    margin: 20px 0 10px 0;
}

.scenario-content ul, 
.scenario-content ol {
    margin: 10px 0;
    padding-left: 30px;
}

.scenario-loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* Drug selection button hover effects */
#drugAButton:hover {
    background: #d4edda !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(39, 174, 96, 0.2);
}

#drugBButton:hover {
    background: #cce7ff !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2);
}

#drugAButton, #drugBButton {
    transition: all 0.2s ease;
}
        
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dual Drug GI PKPD Simulator</h1>
            <p>Simulate drug absorption, distribution, and pharmacodynamic effects</p>
        </div>
        
        <div class="main-grid">
            <div class="controls">
                <h3>Parameters</h3>
                
                <div class="data-sources-section" style="margin-bottom: 20px;">
                    <h4>Data Sources</h4>
                    
                    <div class="source-section" style="background: #e8f5e8; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <h5 style="margin: 0 0 10px 0; color: #2d5016; font-size: 0.9rem;">Patient Data</h5>
                        <div class="control-group" style="margin-bottom: 8px;">
    <label style="font-size: 0.8rem;">Patient Sheet ID:</label>
    <input type="text" id="patientSheetId" placeholder="Enter Google Sheet ID" style="width: calc(100% - 12px); padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box;">
    <button id="loadPatientBtn" onclick="loadPatientSheet()" class="load-button not-loaded" style="color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; width: calc(100% - 12px); box-sizing: border-box; margin-top: 5px;">Load Patient Sheet</button>
</div>
                        <div class="control-group" style="margin-bottom: 8px;">
                            <label style="font-size: 0.8rem;">Select Patient:</label>
                            <select id="patientSelect" style="width: calc(100% - 12px); padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box;" onchange="loadPatientData()">
                                <option value="">Select a patient...</option>
                            </select>
                        </div>
                        <!-- Hidden field to store scenario URL -->
<input type="hidden" id="scenarioUrl">
                        
<button id="scenarioBtn" onclick="openScenarioModal()" style="background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; width: calc(100% - 12px); box-sizing: border-box;" disabled>View Scenario Description</button>
                    </div>
                    
                    <div class="source-section" style="background: #e3f2fd; padding: 12px; border-radius: 8px;">
                        <h5 style="margin: 0 0 10px 0; color: #1565c0; font-size: 0.9rem;">Drug Data</h5>
        <div class="control-group" style="margin-bottom: 8px;">
    <label style="font-size: 0.8rem;">Drug Sheet ID:</label>
    <input type="text" id="drugSheetId" placeholder="Enter Google Sheet ID" style="width: calc(100% - 12px); padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box;">
    <button id="loadDrugBtn" onclick="loadDrugSheet()" class="load-button not-loaded" style="color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; width: calc(100% - 12px); box-sizing: border-box; margin-top: 5px;">Load Drug Sheet</button>
</div>
                        <!-- Replace this section in your HTML -->
                    <div class="control-group" style="margin-bottom: 4px;">
                        <label style="font-size: 0.8rem;">Select Drug A:</label>
                       <button id="drugAButton" onclick="openDrugPopup('A')" style="width: calc(100% - 12px); padding: 6px; border: 2px solid #27ae60; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box; background: #e8f5e8; color: #27ae60; cursor: pointer; font-weight: bold;">
    <span id="drugASelected">Select Drug A...</span>
</button>
                    </div>
                    <div class="control-group" style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem;">Select Drug B:</label>
                        <button id="drugBButton" onclick="openDrugPopup('B')" style="width: calc(100% - 12px); padding: 6px; border: 2px solid #3498db; border-radius: 4px; font-size: 0.8rem; box-sizing: border-box; background: #e3f2fd; color: #3498db; cursor: pointer; font-weight: bold;">
    <span id="drugBSelected">Select Drug B...</span>
</button>
                    </div>

                    </div>
                </div>
                
                <div class="drug-tabs">
                    <button class="drug-tab active" onclick="switchTab(1)">Drug A</button>
                    <button class="drug-tab" onclick="switchTab(2)">Drug B</button>
                </div>
                
                <div class="drug-panel active" id="panel1">
                    <div class="control-group">
                        <label><input type="checkbox" id="enabled1" onchange="runSim()"> Enable Drug A</label>
                    </div>
                    
                    <div class="dosing-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Dosing Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>Dose (mg):</label>
                                <input type="range" id="dose1" min="0" max="500" value="50" oninput="updateVal('dose1'); runSim();">
                                <div class="value" id="dose1Val">50 mg</div>
                            </div>
                            <div class="control-group">
                                <label>Admin Time (hrs):</label>
                                <input type="range" id="adminTime1" min="0" max="12" step="0.5" value="0" oninput="updateVal('adminTime1'); runSim();">
                                <div class="value" id="adminTime1Val">0 hrs</div>
                            </div>
                            <div class="control-group">
                                <label>Dosing Interval (hrs):</label>
                                <input type="range" id="interval1" min="0" max="24" step="1" value="0" oninput="updateVal('interval1'); runSim();">
                                <div class="value" id="interval1Val">0 hrs (single dose)</div>
                            </div>
                            <div class="control-group">
                                <label>Number of Doses:</label>
                                <input type="range" id="numDoses1" min="1" max="90" step="1" value="1" oninput="updateVal('numDoses1'); runSim();">
                                <div class="value" id="numDoses1Val">1</div>
                            </div>
                            <div class="control-group">
                                <label>Dissolution Rate:</label>
                                <input type="range" id="dissolution1" min="0" max="10" step="0.01" value="0.1" oninput="updateVal('dissolution1'); runSim();">
                                <div class="value" id="dissolution1Val">0.1</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="transit-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Transit Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>Stomach Transit:</label>
                                <input type="range" id="stomachTransit1" min="0.01" max="0.5" step="0.01" value="0.2" oninput="updateVal('stomachTransit1'); runSim();">
                                <div class="value" id="stomachTransit1Val">0.2</div>
                            </div>
                            <div class="control-group">
                                <label>Intestine Transit:</label>
                                <input type="range" id="intestineTransit1" min="0.01" max="0.5" step="0.01" value="0.15" oninput="updateVal('intestineTransit1'); runSim();">
                                <div class="value" id="intestineTransit1Val">0.15</div>
                            </div>
                            <div class="control-group">
                                <label>Waste Elimination (%):</label>
                                <input type="range" id="wasteElim1" min="0" max="50" step="1" value="10" oninput="updateVal('wasteElim1'); runSim();">
                                <div class="value" id="wasteElim1Val">10%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absorption-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Absorption Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>Stomach Absorption:</label>
                                <input type="range" id="stomachAbs1" min="0.01" max="0.5" step="0.01" value="0.05" oninput="updateVal('stomachAbs1'); runSim();">
                                <div class="value" id="stomachAbs1Val">0.05</div>
                            </div>
                            <div class="control-group">
                                <label>Small Intestine Absorption:</label>
                                <input type="range" id="siAbs1" min="0.01" max="0.8" step="0.01" value="0.3" oninput="updateVal('siAbs1'); runSim();">
                                <div class="value" id="siAbs1Val">0.3</div>
                            </div>
                            <div class="control-group">
                                <label>Large Intestine Absorption:</label>
                                <input type="range" id="liAbs1" min="0.01" max="0.3" step="0.01" value="0.1" oninput="updateVal('liAbs1'); runSim();">
                                <div class="value" id="liAbs1Val">0.1</div>
                            </div>
                            <div class="control-group">
                                <label>Distribution to Tissue:</label>
                                <input type="range" id="distribution1" min="0.01" max="0.5" step="0.01" value="0.1" oninput="updateVal('distribution1'); runSim();">
                                <div class="value" id="distribution1Val">0.1</div>
                            </div>
                            <div class="control-group">
                                <label>Redistribution from Tissue:</label>
                                <input type="range" id="redistribution1" min="0.01" max="0.3" step="0.01" value="0.05" oninput="updateVal('redistribution1'); runSim();">
                                <div class="value" id="redistribution1Val">0.05</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absorption-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            PK/PD Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>EC50 (nM):</label>
                                <input type="range" id="ec501" min="0.1" max="50" step="0.1" value="2.0" oninput="updateVal('ec501'); runSim();">
                                <div class="value" id="ec501Val">2.0</div>
                            </div>
                            <div class="control-group">
                                <label>Emax:</label>
                                <input type="range" id="emax1" min="-100" max="100" step="5" value="-50" oninput="updateVal('emax1'); runSim();">
                                <div class="value" id="emax1Val">-50</div>
                            </div>
                            <div class="control-group">
                                <label>Bioavailability:</label>
                                <input type="range" id="bioavailability1" min="0.01" max="1.0" step="0.01" value="0.7" oninput="updateVal('bioavailability1'); runSim();">
                                <div class="value" id="bioavailability1Val">0.7</div>
                            </div>
                            <div class="control-group">
                                <label>Half-life (hrs):</label>
                                <input type="range" id="halflife1" min="0.5" max="24" step="0.5" value="6.9" oninput="updateVal('halflife1'); runSim();">
                                <div class="value" id="halflife1Val">6.9 hrs</div>
                            </div>
                        </div>
                    </div>

                    <div class="target-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Drug A GI Target
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>GI Target Effect:</label>
                                <input type="range" id="giTargetEffect1" min="0" max="200" step="1" value="10" oninput="updateVal('giTargetEffect1'); runSim();">
                                <div class="value" id="giTargetEffect1Val">90</div>
                            </div>
                            <div class="control-group">
                                <label>GI Target Range (±%):</label>
                                <input type="range" id="giTargetRange1" min="1" max="100" step="0.1" value="12" oninput="updateVal('giTargetRange1'); runSim();">
                                <div class="value" id="giTargetRange1Val">±12%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="drug-panel" id="panel2">
                    <div class="control-group">
                        <label><input type="checkbox" id="enabled2" onchange="runSim()"> Enable Drug B</label>
                    </div>
                    
                    <div class="dosing-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Dosing Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>Dose (mg):</label>
                                <input type="range" id="dose2" min="0" max="500" value="75" oninput="updateVal('dose2'); runSim();">
                                <div class="value" id="dose2Val">75 mg</div>
                            </div>
                            <div class="control-group">
                                <label>Admin Time (hrs):</label>
                                <input type="range" id="adminTime2" min="0" max="12" step="0.5" value="0" oninput="updateVal('adminTime2'); runSim();">
                                <div class="value" id="adminTime2Val">0 hrs</div>
                            </div>
                            <div class="control-group">
                                <label>Dosing Interval (hrs):</label>
                                <input type="range" id="interval2" min="0" max="24" step="1" value="0" oninput="updateVal('interval2'); runSim();">
                                <div class="value" id="interval2Val">0 hrs (single dose)</div>
                            </div>
                            <div class="control-group">
                                <label>Number of Doses:</label>
                                <input type="range" id="numDoses2" min="1" max="90" step="1" value="1" oninput="updateVal('numDoses2'); runSim();">
                                <div class="value" id="numDoses2Val">1</div>
                            </div>
                            <div class="control-group">
                                <label>Dissolution Rate:</label>
                                <input type="range" id="dissolution2" min="0" max="10" step="0.01" value="0.15" oninput="updateVal('dissolution2'); runSim();">
                                <div class="value" id="dissolution2Val">0.15</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="transit-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Transit Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>Stomach Transit:</label>
                                <input type="range" id="stomachTransit2" min="0.01" max="0.5" step="0.01" value="0.2" oninput="updateVal('stomachTransit2'); runSim();">
                                <div class="value" id="stomachTransit2Val">0.2</div>
                            </div>
                            <div class="control-group">
                                <label>Intestine Transit:</label>
                                <input type="range" id="intestineTransit2" min="0.01" max="0.5" step="0.01" value="0.15" oninput="updateVal('intestineTransit2'); runSim();">
                                <div class="value" id="intestineTransit2Val">0.15</div>
                            </div>
                            <div class="control-group">
                                <label>Waste Elimination (%):</label>
                                <input type="range" id="wasteElim2" min="0" max="50" step="1" value="10" oninput="updateVal('wasteElim2'); runSim();">
                                <div class="value" id="wasteElim2Val">10%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absorption-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Absorption Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>Stomach Absorption:</label>
                                <input type="range" id="stomachAbs2" min="0.01" max="0.5" step="0.01" value="0.03" oninput="updateVal('stomachAbs2'); runSim();">
                                <div class="value" id="stomachAbs2Val">0.03</div>
                            </div>
                            <div class="control-group">
                                <label>Small Intestine Absorption:</label>
                                <input type="range" id="siAbs2" min="0.01" max="0.8" step="0.01" value="0.4" oninput="updateVal('siAbs2'); runSim();">
                                <div class="value" id="siAbs2Val">0.4</div>
                            </div>
                            <div class="control-group">
                                <label>Large Intestine Absorption:</label>
                                <input type="range" id="liAbs2" min="0.01" max="0.3" step="0.01" value="0.08" oninput="updateVal('liAbs2'); runSim();">
                                <div class="value" id="liAbs2Val">0.08</div>
                            </div>
                            <div class="control-group">
                                <label>Distribution to Tissue:</label>
                                <input type="range" id="distribution2" min="0.01" max="0.5" step="0.01" value="0.1" oninput="updateVal('distribution2'); runSim();">
                                <div class="value" id="distribution2Val">0.1</div>
                            </div>
                            <div class="control-group">
                                <label>Redistribution from Tissue:</label>
                                <input type="range" id="redistribution2" min="0.01" max="0.3" step="0.01" value="0.05" oninput="updateVal('redistribution2'); runSim();">
                                <div class="value" id="redistribution2Val">0.05</div>
                            </div>
                        </div>
                    </div>

                    <div class="absorption-section">
                    <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            PK/PD Parameters
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>EC50 (nM):</label>
                                <input type="range" id="ec502" min="0.1" max="50" step="0.1" value="5.0" oninput="updateVal('ec502'); runSim();">
                                <div class="value" id="ec502Val">5.0</div>
                            </div>
                            <div class="control-group">
                                <label>Emax:</label>
                                <input type="range" id="emax2" min="-100" max="100" step="5" value="-60" oninput="updateVal('emax2'); runSim();">
                                <div class="value" id="emax2Val">-60</div>
                            </div>
                            <div class="control-group">
                                <label>Bioavailability:</label>
                                <input type="range" id="bioavailability2" min="0.01" max="1.0" step="0.01" value="0.8" oninput="updateVal('bioavailability2'); runSim();">
                                <div class="value" id="bioavailability2Val">0.8</div>
                            </div>
                            <div class="control-group">
                                <label>Half-life (hrs):</label>
                                <input type="range" id="halflife2" min="0.5" max="24" step="0.5" value="8.7" oninput="updateVal('halflife2'); runSim();">
                                <div class="value" id="halflife2Val">8.7 hrs</div>
                            </div>
                        </div>
                    </div>

                    <div class="target-section">
                        <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                            Drug B GI Target
                            <span class="collapse-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="control-group">
                                <label>GI Target Effect:</label>
                                <input type="range" id="giTargetEffect2" min="0" max="200" step="1" value="15" oninput="updateVal('giTargetEffect2'); runSim();">
                                <div class="value" id="giTargetEffect2Val">80</div>
                            </div>
                            <div class="control-group">
                                <label>GI Target Range (±%):</label>
                                <input type="range" id="giTargetRange2" min="1" max="100" step="0.1" value="18" oninput="updateVal('giTargetRange2'); runSim();">
                                <div class="value" id="giTargetRange2Val">±18%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="interaction-section">
                    <h3 class="collapsible-header" onclick="toggleCollapse(this)">
                        Drug Interactions
                        <span class="collapse-icon">▼</span>
                    </h3>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <label>Interaction Type:</label>
                            <select id="interactionType" onchange="runSim()">
                                <option value="additive">Additive</option>
                                <option value="synergistic">Synergistic</option>
                                <option value="antagonistic">Antagonistic</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Interaction Factor:</label>
                            <input type="range" id="interactionFactor" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVal('interactionFactor'); runSim();">
                            <div class="value" id="interactionFactorVal">1.0</div>
                        </div>
                    </div>
                </div>
                
                <div class="target-section">
                    <h4 class="collapsible-header" onclick="toggleCollapse(this)">
                        Pharmacodynamic Targets
                        <span class="collapse-icon">▼</span>
                    </h4>
                    <div class="collapsible-content">
                        <div class="control-group">
                            <label>Baseline Effect:</label>
                            <input type="range" id="baseline" min="50" max="200" step="5" value="120" oninput="updateVal('baseline'); runSim();">
                            <div class="value" id="baselineVal">120</div>
                        </div>
                        <div class="control-group">
                            <label>PD Target Effect:</label>
                            <input type="range" id="pdTargetEffect" min="50" max="200" step="5" value="90" oninput="updateVal('pdTargetEffect'); runSim();">
                            <div class="value" id="pdTargetEffectVal">90</div>
                        </div>
                        <div class="control-group">
                            <label>PD Target Range (±%):</label>
                            <input type="range" id="pdTargetRange" min="1" max="50" step="1" value="10" oninput="updateVal('pdTargetRange'); runSim();">
                            <div class="value" id="pdTargetRangeVal">±10%</div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Simulation Time (hrs):</label>
                    <input type="range" id="simTime" min="0" max="720" step="6" value="24" oninput="updateVal('simTime'); runSim();">
                    <div class="value" id="simTimeVal">24 hrs</div>
                </div>
                
                <button class="run-button" onclick="runSim()">Run Simulation</button>
            </div>
            
            <div class="charts">
                <div class="chart-container">
                    <h4>Drug Release & Dissolution</h4>
                    <div class="chart-wrapper">
                        <canvas id="chart1"></canvas>
                    </div>
                    <div class="chart-info">Tablet dissolution and dissolved drug profiles</div>
                </div>
                
                <div class="chart-container">
                    <h4>GI Distribution & Plasma</h4>
                    <div class="chart-wrapper">
                        <canvas id="chart2"></canvas>
                    </div>
                    <div class="chart-info">Complete drug journey: GI + plasma + tissue distribution with therapeutic guidelines</div>
                </div>
                
                <div class="chart-container">
                    <h4>Combined Pharmacodynamic Effects</h4>
                    <div class="chart-wrapper">
                        <canvas id="chart3"></canvas>
                    </div>
                    <div class="chart-info">Individual and combined drug effects with PD-specific interactions and targets</div>
                    
                    <div class="max-effects-grid">
                        <div class="max-effect-card drug-a">
                            <div class="max-effect-value" id="maxEffect1">-</div>
                            <div class="max-effect-label">Max Effect A</div>
                        </div>
                        <div class="max-effect-card drug-b">
                            <div class="max-effect-value" id="maxEffect2">-</div>
                            <div class="max-effect-label">Max Effect B</div>
                        </div>
                        <div class="max-effect-card combined">
                            <div class="max-effect-value" id="maxEffect">-</div>
                            <div class="max-effect-label">Max Combined Effect</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h4>Results</h4>
                    <div class="stats-grid">
                        <div class="stat-card drug-a"><div class="stat-value" id="cmax1">-</div><div class="stat-label">Drug A Cmax</div></div>
                        <div class="stat-card drug-a"><div class="stat-value" id="tmax1">-</div><div class="stat-label">Drug A Tmax</div></div>
                        <div class="stat-card drug-a"><div class="stat-value" id="auc1">-</div><div class="stat-label">Drug A AUC</div></div>
                        <div class="stat-card drug-b"><div class="stat-value" id="cmax2">-</div><div class="stat-label">Drug B Cmax</div></div>
                        <div class="stat-card drug-b"><div class="stat-value" id="tmax2">-</div><div class="stat-label">Drug B Tmax</div></div>
                        <div class="stat-card drug-b"><div class="stat-value" id="auc2">-</div><div class="stat-label">Drug B AUC</div></div> 
                        <div class="stat-card assessment"><div class="stat-value" id="giAssessmentGrade1">-</div><div class="stat-label">GI A Assessment</div></div>
                        <div class="stat-card assessment"><div class="stat-value" id="giAssessmentGrade2">-</div><div class="stat-label">GI B Assessment</div></div>
                        <div class="stat-card assessment"><div class="stat-value" id="assessmentGrade">-</div><div class="stat-label">PD Assessment</div></div>
                    </div>
                    <div class="assessment-feedback" id="giAssessmentFeedback1"></div>
                    <div class="assessment-feedback" id="giAssessmentFeedback2"></div>
                    <div class="assessment-feedback" id="assessmentFeedback"></div>
                </div>
            </div>
        </div>
    </div>

<!-- Drug Selection Modal -->
<div id="drugModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Select Drug</h3>
            <span class="close" onclick="closeDrugModal()">&times;</span>
        </div>
        <div class="modal-body">
            <table id="drugTable" class="drug-table">
                <thead>
                    <tr>
                        <th>Drug Name</th>
<th>EC50 (nM)</th>
<th>Emax</th>
<th>Half-life (hrs)</th>
<th>Bioavailability</th>
<th>Volume of Distribution (L/kg)</th>
<th>Dose (mg)</th>
<th>Dissolution Rate</th>
<th>Action</th>
                    </tr>
                </thead>
                <tbody id="drugTableBody">
                    <!-- Drug rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Drug Configuration Modal -->
<div id="drugConfigModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="configModalTitle">Configure Drug</h3>
            <span class="close" onclick="closeDrugConfigModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="config-section">
                <h4 id="selectedDrugName">Drug Name</h4>
                <div class="config-grid">
                    <div class="config-group">
                        <label>Select Dose:</label>
                        <div id="doseOptions" class="option-grid">
                            <!-- Dose buttons will be populated here -->
                        </div>
                        <div class="selected-value">Selected: <span id="selectedDose">None</span> mg</div>
                    </div>
                    <div class="config-group">
                        <label>Select Dissolution Rate:</label>
                        <div id="dissolutionOptions" class="option-grid">
                            <!-- Dissolution buttons will be populated here -->
                        </div>
                        <div class="selected-value">Selected: <span id="selectedDissolution">None</span></div>
                    </div>
                </div>
                <div class="config-actions">
                    <button class="cancel-btn" onclick="closeDrugConfigModal()">Cancel</button>
                    <button class="choose-drug-btn" onclick="finalizeDrugSelection()" id="chooseDrugBtn" disabled>Choose Drug</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Scenario Description Modal -->
<div id="scenarioModal" class="scenario-modal" style="display: none;">
    <div class="scenario-modal-content">
        <div class="scenario-modal-header">
            <h3 id="scenarioModalTitle">Scenario Description</h3>
            <span class="close" onclick="closeScenarioModal()">&times;</span>
        </div>
        <div class="scenario-modal-body">
            <div id="scenarioContent" class="scenario-content">
                <div class="scenario-loading">Loading scenario description...</div>
            </div>
        </div>
    </div>
</div>


    
<script>
// Global variables for sheet data
var patientData = [];
var drugData = [];

var currentDrugIndex = null;
var currentDrugData = null;
var selectedDose = null;
var selectedDissolution = null;

// Google Sheets API functions
function loadPatientSheet() {
    var sheetId = document.getElementById('patientSheetId').value.trim();
    if (!sheetId) {
        alert('Please enter a Patient Sheet ID');
        return;
    }
    
    var url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
    
    fetch(url)
        .then(response => response.text())
        .then(data => {
            patientData = parseCSV(data);
            populatePatientDropdown();
            // Update button to green on success
            var btn = document.getElementById('loadPatientBtn');
            btn.classList.remove('not-loaded');
            btn.classList.add('loaded');
            btn.textContent = 'Patient Sheet Loaded ✓';
        })
        .catch(error => {
            console.error('Error loading patient sheet:', error);
            alert('Error loading patient sheet. Please check the Sheet ID and make sure the sheet is publicly accessible.');
            // Keep button red on error
            var btn = document.getElementById('loadPatientBtn');
            btn.classList.remove('loaded');
            btn.classList.add('not-loaded');
        });
}

function loadDrugSheet() {
    var sheetId = document.getElementById('drugSheetId').value.trim();
    if (!sheetId) {
        alert('Please enter a Drug Sheet ID');
        return;
    }
    
    var url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
    
    fetch(url)
        .then(response => response.text())
        .then(data => {
            console.log('=== RAW CSV DATA ===');
            console.log(data);
            console.log('=== END RAW CSV ===');
            
            drugData = parseCSV(data);
            console.log('Drug data loaded successfully. ' + drugData.length + ' drugs available.');
            
            // Update button to green on success
            var btn = document.getElementById('loadDrugBtn');
            btn.classList.remove('not-loaded');
            btn.classList.add('loaded');
            btn.textContent = 'Drug Sheet Loaded ✓';
        })
        .catch(error => {
            console.error('Error loading drug sheet:', error);
            alert('Error loading drug sheet. Please check the Sheet ID and make sure the sheet is publicly accessible.');
            // Keep button red on error
            var btn = document.getElementById('loadDrugBtn');
            btn.classList.remove('loaded');
            btn.classList.add('not-loaded');
        });
}

function parseCSV(csvText) {
    var lines = csvText.split('\n');
    var data = [];
    
  // Parse the header row
var headerLine = lines[0];
var headers = parseCSVLine(headerLine);
console.log('=== PARSED HEADERS ===');
console.log('Headers array:', headers);
console.log('Number of headers:', headers.length);
headers.forEach((header, index) => {
    console.log(`Column ${index}: "${header}"`);
});
console.log('=== END HEADERS ===');

    
    
    // Parse data rows
    for (var i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            var values = parseCSVLine(lines[i]);
            var row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            // Also store the first column as 'Name' for consistency
            if (values[0]) {
                row['Name'] = values[0];
            }
            data.push(row);
        }
    }
    
    return data;
}


// Helper function to properly parse CSV lines with quoted comma-separated values
function parseCSVLine(line) {
    var result = [];
    var current = '';
    var inQuotes = false;
    
    for (var i = 0; i < line.length; i++) {
        var char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    // Add the last field
    result.push(current.trim());
    
    return result;
}

function populatePatientDropdown() {
    var select = document.getElementById('patientSelect');
    select.innerHTML = '<option value="">Select a patient...</option>';
    
    patientData.forEach((patient, index) => {
        var option = document.createElement('option');
        option.value = index;
        // Use the first column (column A) as the display name
        var firstName = Object.values(patient)[0] || `Patient ${index + 1}`;
        option.textContent = firstName;
        select.appendChild(option);
    });
}

function populateDrugDropdowns() {
    // Drugs are now selected via popup modal, no dropdowns to populate
    console.log('Drug data loaded successfully. ' + drugData.length + ' drugs available.');
}

function loadPatientData() {
    var patientIndex = document.getElementById('patientSelect').value;
    if (patientIndex === '') return;
    
    var patient = patientData[patientIndex];
    if (!patient) return;
    
    // Map patient data to UI controls with proper value updates
    // Transit parameters (case-sensitive field names from sheet)
    if (patient['Stomach Transit']) {
        setSliderValue('stomachTransit1', patient['Stomach Transit']);
        setSliderValue('stomachTransit2', patient['Stomach Transit']);
    }
    
    if (patient['Intestine Transit']) {
        setSliderValue('intestineTransit1', patient['Intestine Transit']);
        setSliderValue('intestineTransit2', patient['Intestine Transit']);
    }
    
    // Absorption parameters
    if (patient['Stomach Absorption']) {
        setSliderValue('stomachAbs1', patient['Stomach Absorption']);
        setSliderValue('stomachAbs2', patient['Stomach Absorption']);
    }
    
    if (patient['Small Intestine Absorption']) {
        setSliderValue('siAbs1', patient['Small Intestine Absorption']);
        setSliderValue('siAbs2', patient['Small Intestine Absorption']);
    }
    
    if (patient['Large Intestine Absorption']) {
        setSliderValue('liAbs1', patient['Large Intestine Absorption']);
        setSliderValue('liAbs2', patient['Large Intestine Absorption']);
    }
    
    // Distribution parameters
    if (patient['Distribution to Tissue']) {
        setSliderValue('distribution1', patient['Distribution to Tissue']);
        setSliderValue('distribution2', patient['Distribution to Tissue']);
    }
    
    if (patient['Redistribution from Tissue']) {
        setSliderValue('redistribution1', patient['Redistribution from Tissue']);
        setSliderValue('redistribution2', patient['Redistribution from Tissue']);
    }
    
    // Waste elimination
    if (patient['Waste Elimination (%)']) {
        setSliderValue('wasteElim1', patient['Waste Elimination (%)']);
        setSliderValue('wasteElim2', patient['Waste Elimination (%)']);
    }
    
    // PD parameters
    if (patient['Baseline Effect']) {
        setSliderValue('baseline', patient['Baseline Effect']);
    }
    
    if (patient['PD Target Effect']) {
        setSliderValue('pdTargetEffect', patient['PD Target Effect']);
    }
    
    if (patient['PD Target Range']) {
        setSliderValue('pdTargetRange', patient['PD Target Range']);
    }
    
    // Load scenario URL if available
    var scenarioUrl = patient['Scenario URL'] || patient['Scenario Document'] || '';
    document.getElementById('scenarioUrl').value = scenarioUrl;
    
    // Enable/disable scenario button based on URL availability
    var scenarioBtn = document.getElementById('scenarioBtn');
    if (scenarioUrl) {
        scenarioBtn.disabled = false;
        scenarioBtn.style.opacity = '1';
    } else {
        scenarioBtn.disabled = true;
        scenarioBtn.style.opacity = '0.5';
    }
    
    runSim();
}

function loadDrugData(drugSlot) {
    var selectId = drugSlot === 'A' ? 'drugASelect' : 'drugBSelect';
    var drugIndex = document.getElementById(selectId).value;
    if (drugIndex === '') return;
    
    var drug = drugData[drugIndex];
    if (!drug) return;
    
    var drugNum = drugSlot === 'A' ? '1' : '2';
    
    // Map drug data to UI controls with proper value updates
    // Use exact field names from the Google Sheet
    if (drug['EC50 (nM)']) {
        setSliderValue('ec50' + drugNum, drug['EC50 (nM)']);
    }
    
    if (drug['Emax']) {
        setSliderValue('emax' + drugNum, drug['Emax']);
    }
    
    if (drug['Bioavailability']) {
        setSliderValue('bioavailability' + drugNum, drug['Bioavailability']);
    }
    
    if (drug['Half-life (hrs)']) {
        setSliderValue('halflife' + drugNum, drug['Half-life (hrs)']);
    }
    
    if (drug['Dissolution Rate']) {
        setSliderValue('dissolution' + drugNum, drug['Dissolution Rate']);
    }
    
    if (drug['Distribution to Tissue']) {
        setSliderValue('distribution' + drugNum, drug['Distribution to Tissue']);
    }
    
    if (drug['Redistribution from Tissue']) {
        setSliderValue('redistribution' + drugNum, drug['Redistribution from Tissue']);
    }
    
    if (drug['GI Target Effect']) {
        setSliderValue('giTargetEffect' + drugNum, drug['GI Target Effect']);
    }
    
    if (drug['GI Target Range']) {
        setSliderValue('giTargetRange' + drugNum, drug['GI Target Range']);
    }
    
    if (drug['Volume of Distribution (L/kg)']) {
        setSliderValue('vd' + drugNum, drug['Volume of Distribution (L/kg)']);
    }
    
    // Additional absorption parameters from drug sheet
    if (drug['Stomach Absorption']) {
        setSliderValue('stomachAbs' + drugNum, drug['Stomach Absorption']);
    }
    
    if (drug['Small Intestine Absorption']) {
        setSliderValue('siAbs' + drugNum, drug['Small Intestine Absorption']);
    }
    
    if (drug['Large Intestine Absorption']) {
        setSliderValue('liAbs' + drugNum, drug['Large Intestine Absorption']);
    }
    
    // Transit parameters from drug sheet
    if (drug['Stomach Transit']) {
        setSliderValue('stomachTransit' + drugNum, drug['Stomach Transit']);
    }
    
    if (drug['Intestine Transit']) {
        setSliderValue('intestineTransit' + drugNum, drug['Intestine Transit']);
    }
    
    // Waste elimination
    if (drug['Waste Elimination (%)']) {
        setSliderValue('wasteElim' + drugNum, drug['Waste Elimination (%)']);
    }
    
    runSim();
}

// Helper function to set slider value and update display
function setSliderValue(sliderId, value) {
    var slider = document.getElementById(sliderId);
    if (slider && value !== undefined && value !== '') {
        // Convert string values to numbers
        var numericValue = parseFloat(value);
        if (!isNaN(numericValue)) {
            slider.value = numericValue;
            updateVal(sliderId);
        }
    }
}
function toggleCollapse(header) {
    var content = header.nextElementSibling;
    var icon = header.querySelector('.collapse-icon');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        content.style.maxHeight = content.scrollHeight + 'px';
        icon.classList.remove('collapsed');
    } else {
        content.classList.add('collapsed');
        content.style.maxHeight = '0px';
        icon.classList.add('collapsed');
    }
}

function switchTab(n) {
    document.querySelectorAll('.drug-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.drug-panel').forEach(function(p) { p.classList.remove('active'); });
    document.querySelector('.drug-tab:nth-child(' + n + ')').classList.add('active');
    document.getElementById('panel' + n).classList.add('active');
}

function updateVal(id) {
    var el = document.getElementById(id);
    var val = document.getElementById(id + 'Val');
    if (el && val) {
        var v = el.value;
        if (id.includes('dose')) v += ' mg';
        else if (id.includes('Time') || id.includes('halflife')) v += ' hrs';
        else if (id.includes('wasteElim')) v += '%';
        else if (id.includes('Range')) v = '±' + v + '%';
        else if (id.includes('vd')) v += ' L/kg';
        else if (id.includes('interval')) {
            if (parseFloat(v) === 0) v += ' hrs (single dose)';
            else v += ' hrs';
        }
        val.textContent = v;
    }
}

function getVal(id) {
    var el = document.getElementById(id);
    return el ? parseFloat(el.value) : 0;
}

function getCheck(id) {
    var el = document.getElementById(id);
    return el ? el.checked : false;
}

function getSelect(id) {
    var el = document.getElementById(id);
    return el ? el.value : '';
}

function calculateElimFromHalflife(halflife) {
    return Math.log(2) / halflife;
}

function combineEffects(e1, e2, type, factor) {
    switch (type) {
        case 'additive': return e1 + e2;
        case 'synergistic': return (e1 + e2) * factor;
        case 'antagonistic': return (e1 + e2) / factor;
        default: return e1 + e2;
    }
}

function assessTherapeuticWindow(data, baseline, target, targetUpper, targetLower) {
    var firstInRange = -1;
    var totalInRange = 0;
    var consecutiveFailureAfterSuccess = false;
    
    // Count all time points in range for percentage calculation
    for (var i = 0; i < data.length; i++) {
        var effect = data[i].combinedEffect;
        var inRange = effect >= targetLower && effect <= targetUpper;
        
        if (inRange) {
            if (firstInRange === -1) firstInRange = i;
            totalInRange++;
        }
    }
    
    // Check for sustained success (no gaps after first reaching target)
    if (firstInRange !== -1) {
        for (var i = firstInRange; i < data.length; i++) {
            var effect = data[i].combinedEffect;
            var inRange = effect >= targetLower && effect <= targetUpper;
            
            if (!inRange) {
                consecutiveFailureAfterSuccess = true;
                break;
            }
        }
    }
    
    var percentInRange = (totalInRange / data.length) * 100;
    var timeToTarget = firstInRange !== -1 ? data[firstInRange].time : null;
    
    var maxAllowedTime = data[data.length - 1].time * 0.75;
    var reachesTarget = timeToTarget !== null && timeToTarget <= maxAllowedTime;
    var maintainsTarget = firstInRange !== -1 && !consecutiveFailureAfterSuccess;
    
    var passed = reachesTarget && maintainsTarget;
    
    return {
        passed: passed,
        percentInRange: percentInRange,
        timeToTarget: timeToTarget,
        sustainedSuccess: maintainsTarget,
        reachesTarget: reachesTarget,
        maintainsTarget: maintainsTarget,
        grade: passed ? 'PASS' : 'FAIL',
        feedback: generateFeedback(passed, reachesTarget, maintainsTarget, percentInRange, timeToTarget)
    };
}

function assessGIWindow(data, baseline, target, targetUpper, targetLower, drugNum) {
    var firstInRange = -1;
    var totalInRange = 0;
    var consecutiveFailureAfterSuccess = false;
    
    // Count all time points in range for percentage calculation
    for (var i = 0; i < data.length; i++) {
        var plasma = drugNum === 1 ? data[i].drug1.plasma : data[i].drug2.plasma;
        var inRange = plasma >= targetLower && plasma <= targetUpper;
        
        if (inRange) {
            if (firstInRange === -1) firstInRange = i;
            totalInRange++;
        }
    }
    
    // Check for sustained success (no gaps after first reaching target)
    if (firstInRange !== -1) {
        for (var i = firstInRange; i < data.length; i++) {
            var plasma = drugNum === 1 ? data[i].drug1.plasma : data[i].drug2.plasma;
            var inRange = plasma >= targetLower && plasma <= targetUpper;
            
            if (!inRange) {
                consecutiveFailureAfterSuccess = true;
                break;
            }
        }
    }
    
    var percentInRange = (totalInRange / data.length) * 100;
    var timeToTarget = firstInRange !== -1 ? data[firstInRange].time : null;
    
    var maxAllowedTime = data[data.length - 1].time * 0.75;
    var reachesTarget = timeToTarget !== null && timeToTarget <= maxAllowedTime;
    var maintainsTarget = firstInRange !== -1 && !consecutiveFailureAfterSuccess;
    
    var passed = reachesTarget && maintainsTarget;
    
    return {
        passed: passed,
        percentInRange: percentInRange,
        timeToTarget: timeToTarget,
        sustainedSuccess: maintainsTarget,
        reachesTarget: reachesTarget,
        maintainsTarget: maintainsTarget,
        grade: passed ? 'PASS' : 'FAIL',
        feedback: generateGIFeedback(passed, reachesTarget, maintainsTarget, percentInRange, timeToTarget, drugNum)
    };
}

function generateFeedback(passed, reachesTarget, maintainsTarget, percentInRange, timeToTarget) {
    if (passed) {
        return 'Therapeutic target achieved and maintained successfully.';
    }
    
    var feedback = [];
    if (!reachesTarget) {
        if (timeToTarget === null) {
            feedback.push('Target effect never reached - adjust doses or timing');
        } else {
            feedback.push('Target reached too late - consider faster-acting formulation');
        }
    }
    
    if (!maintainsTarget) {
        if (percentInRange < 50) {
            feedback.push('Poor target maintenance (' + percentInRange.toFixed(1) + '%) - optimize dosing intervals');
        } else if (percentInRange < 80) {
            feedback.push('Adequate but suboptimal maintenance (' + percentInRange.toFixed(1) + '%) - fine-tune parameters');
        }
    }
    
    return feedback.join('. ');
}

function generateGIFeedback(passed, reachesTarget, maintainsTarget, percentInRange, timeToTarget, drugNum) {
    var drugName = drugNum === 1 ? 'Drug A' : 'Drug B';
    
    if (passed) {
        return drugName + ' GI target achieved and maintained - optimal drug distribution.';
    }
    
    var feedback = [];
    if (!reachesTarget) {
        if (timeToTarget === null) {
            feedback.push(drugName + ' GI target never reached - consider increasing doses or improving formulation');
        } else {
            feedback.push(drugName + ' GI target reached too late - optimize absorption parameters');
        }
    }
    
    if (!maintainsTarget) {
        if (percentInRange < 50) {
            feedback.push('Poor ' + drugName + ' GI maintenance (' + percentInRange.toFixed(1) + '%) - review elimination and distribution rates');
        } else if (percentInRange < 80) {
            feedback.push('Adequate ' + drugName + ' GI maintenance (' + percentInRange.toFixed(1) + '%) - fine-tune PK parameters');
        }
    }
    
    return feedback.join('. ');
}

function simulate() {
    var data = [];
    var dt = 0.1;
    var simTime = getVal('simTime');
    var steps = Math.floor(simTime / dt);
    var baseline = getVal('baseline');
    var interactionType = getSelect('interactionType') || 'additive';
    var interactionFactor = getVal('interactionFactor') || 1.0;
    
    var drug1Params = {
        enabled: getCheck('enabled1'),
        dose: getVal('dose1'),
        adminTime: getVal('adminTime1'),
        interval: getVal('interval1'),
        numDoses: getVal('numDoses1'),
        elim: calculateElimFromHalflife(getVal('halflife1') || 6.9)
    };
    
    var drug2Params = {
        enabled: getCheck('enabled2'),
        dose: getVal('dose2'),
        adminTime: getVal('adminTime2'),
        interval: getVal('interval2'),
        numDoses: getVal('numDoses2'),
        elim: calculateElimFromHalflife(getVal('halflife2') || 8.7)
    };
    
    var drug1DoseTimes = [];
    var drug2DoseTimes = [];
    
    if (drug1Params.enabled) {
        for (var d = 0; d < drug1Params.numDoses; d++) {
            var doseTime = drug1Params.adminTime + (d * drug1Params.interval);
            if (doseTime <= simTime) drug1DoseTimes.push(Math.round(doseTime * 10) / 10);
        }
    }
    
    if (drug2Params.enabled) {
        for (var d = 0; d < drug2Params.numDoses; d++) {
            var doseTime = drug2Params.adminTime + (d * drug2Params.interval);
            if (doseTime <= simTime) drug2DoseTimes.push(Math.round(doseTime * 10) / 10);
        }
    }
    
    var drug1 = { tablet: 0, stomach: 0, si: 0, li: 0, plasma: 0, tissue: 0 };
    var drug2 = { tablet: 0, stomach: 0, si: 0, li: 0, plasma: 0, tissue: 0 };
    
    for (var i = 0; i <= steps; i++) {
        var time = i * dt;
        var currentTime = Math.round(time * 10) / 10;
        
        if (drug1DoseTimes.includes(currentTime)) {
            drug1.tablet += drug1Params.dose;
        }
        if (drug2DoseTimes.includes(currentTime)) {
            drug2.tablet += drug2Params.dose;
        }
        
        if (i % 2 === 0) {
            var e1 = drug1Params.enabled ? calcEffect(drug1.plasma, getVal('ec501'), getVal('emax1')) : 0;
            var e2 = drug2Params.enabled ? calcEffect(drug2.plasma, getVal('ec502'), getVal('emax2')) : 0;
            var combinedE = combineEffects(e1, e2, interactionType, interactionFactor);
            
            var dissolvedDrug1 = 0;
            var dissolvedDrug2 = 0;
            
            if (drug1Params.enabled) {
                for (var d = drug1DoseTimes.length - 1; d >= 0; d--) {
                    var doseStartTime = drug1DoseTimes[d];
                    if (currentTime >= doseStartTime) {
                        var timeFromDose = currentTime - doseStartTime;
                        var dissolutionRate = getVal('dissolution1');
                        var maxDissolution = drug1Params.dose;
                        dissolvedDrug1 = maxDissolution * (1 - Math.exp(-dissolutionRate * timeFromDose));
                        dissolvedDrug1 = Math.min(dissolvedDrug1, maxDissolution);
                        break;
                    }
                }
            }
            
            if (drug2Params.enabled) {
                for (var d = drug2DoseTimes.length - 1; d >= 0; d--) {
                    var doseStartTime = drug2DoseTimes[d];
                    if (currentTime >= doseStartTime) {
                        var timeFromDose = currentTime - doseStartTime;
                        var dissolutionRate = getVal('dissolution2');
                        var maxDissolution = drug2Params.dose;
                        dissolvedDrug2 = maxDissolution * (1 - Math.exp(-dissolutionRate * timeFromDose));
                        dissolvedDrug2 = Math.min(dissolvedDrug2, maxDissolution);
                        break;
                    }
                }
            }
            
            data.push({
                time: currentTime,
                drug1: JSON.parse(JSON.stringify(drug1)),
                drug2: JSON.parse(JSON.stringify(drug2)),
                effect1: e1,
                effect2: e2,
                combinedEffect: baseline + combinedE,
                dissolvedDrug1: dissolvedDrug1,
                dissolvedDrug2: dissolvedDrug2
            });
        }
        
        if (drug1.tablet > 0 || drug1.stomach > 0 || drug1.si > 0 || drug1.li > 0 || drug1.plasma > 0) {
            updateDrug(drug1, 1, dt, drug1Params.elim);
        }
        if (drug2.tablet > 0 || drug2.stomach > 0 || drug2.si > 0 || drug2.li > 0 || drug2.plasma > 0) {
            updateDrug(drug2, 2, dt, drug2Params.elim);
        }
    }
    
    return data;
}

function updateDrug(drug, drugNum, dt, elimRate) {
    var dissolution = Math.max(0, drug.tablet) * getVal('dissolution' + drugNum) * dt;
    var stomachAbs = Math.max(0, drug.stomach) * getVal('stomachAbs' + drugNum) * dt;
    var siAbs = Math.max(0, drug.si) * getVal('siAbs' + drugNum) * dt;
    var liAbs = Math.max(0, drug.li) * getVal('liAbs' + drugNum) * dt;
    var stomachTransit = Math.max(0, drug.stomach) * getVal('stomachTransit' + drugNum) * dt;
    var intestineTransit = Math.max(0, drug.si) * getVal('intestineTransit' + drugNum) * dt;
    var distribution = Math.max(0, drug.plasma) * getVal('distribution' + drugNum) * dt;
    var redistribution = Math.max(0, drug.tissue) * getVal('redistribution' + drugNum) * dt;
    var elimination = Math.max(0, drug.plasma) * elimRate * dt;
    
    var wasteElimPercent = getVal('wasteElim' + drugNum) / 100;
    var wasteElimination = Math.max(0, drug.li) * wasteElimPercent * dt;
    
    var bioavailability = getVal('bioavailability' + drugNum);
    var bioavailableStomachAbs = stomachAbs * bioavailability;
    var bioavailableSiAbs = siAbs * bioavailability;
    var bioavailableLiAbs = liAbs * bioavailability;
    
    drug.tablet = Math.max(0, drug.tablet - dissolution);
    drug.stomach = Math.max(0, drug.stomach + dissolution - stomachAbs - stomachTransit);
    drug.si = Math.max(0, drug.si + stomachTransit - siAbs - intestineTransit);
    drug.li = Math.max(0, drug.li + intestineTransit - liAbs - wasteElimination);
    drug.plasma = Math.max(0, drug.plasma + bioavailableStomachAbs + bioavailableSiAbs + bioavailableLiAbs - elimination - distribution + redistribution);
    drug.tissue = Math.max(0, drug.tissue + distribution - redistribution);
}

function calcEffect(conc, ec50, emax) {
    if (conc <= 0) return 0;
    return (emax * conc) / (ec50 + conc);
}

function calculateStats(data) {
    if (!data.length) return {cmax1: 0, cmax2: 0, tmax1: 0, tmax2: 0, auc1: 0, auc2: 0, maxEffect1: 0, maxEffect2: 0, maxEffect: 0};
    
    var plasma1 = data.map(function(d) { return d.drug1.plasma; });
    var plasma2 = data.map(function(d) { return d.drug2.plasma; });
    var effects1 = data.map(function(d) { return Math.abs(d.effect1); });
    var effects2 = data.map(function(d) { return Math.abs(d.effect2); });
    var effects = data.map(function(d) { return Math.abs(d.combinedEffect - getVal('baseline')); });
    
    var cmax1 = Math.max.apply(Math, plasma1);
    var cmax2 = Math.max.apply(Math, plasma2);
    var tmax1 = plasma1.length > 0 ? data[plasma1.indexOf(cmax1)].time : 0;
    var tmax2 = plasma2.length > 0 ? data[plasma2.indexOf(cmax2)].time : 0;
    
    var auc1 = 0, auc2 = 0;
    for (var i = 1; i < data.length; i++) {
        var dt = data[i].time - data[i-1].time;
        auc1 += (plasma1[i] + plasma1[i-1]) * dt / 2;
        auc2 += (plasma2[i] + plasma2[i-1]) * dt / 2;
    }
    
    var maxEffect1 = Math.max.apply(Math, effects1);
    var maxEffect2 = Math.max.apply(Math, effects2);
    var maxEffect = Math.max.apply(Math, effects);
    
    return {
        cmax1: cmax1,
        cmax2: cmax2,
        tmax1: tmax1,
        tmax2: tmax2,
        auc1: auc1,
        auc2: auc2,
        maxEffect1: maxEffect1,
        maxEffect2: maxEffect2,
        maxEffect: maxEffect
    };
}

var charts = {};

function setupCharts() {
    var opts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: 'Time (hrs)' } },
            y: { title: { display: true, text: 'Amount/Effect' } }
        },
        plugins: {
            legend: {
                labels: {
                    usePointStyle: true,
                    pointStyle: 'circle',
                    boxWidth: 8,
                    boxHeight: 8
                }
            }
        }
    };
    
    charts.release = new Chart(document.getElementById('chart1').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Drug A Tablet', data: [], borderColor: '#27ae60', borderWidth: 3, fill: false, pointRadius: 0 },
            { label: 'Drug B Tablet', data: [], borderColor: '#3498db', borderWidth: 3, fill: false, pointRadius: 0 },
            { label: 'Drug A Dissolved', data: [], borderColor: '#27ae60', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 },
            { label: 'Drug B Dissolved', data: [], borderColor: '#3498db', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 }
        ]},
        options: opts
    });
    
    charts.gi = new Chart(document.getElementById('chart2').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Drug A Stomach', data: [], borderColor: '#27ae60', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug A Small Intestine', data: [], borderColor: '#229954', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug A Large Intestine', data: [], borderColor: '#1e8449', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug A Plasma', data: [], borderColor: '#27ae60', borderWidth: 4, fill: false, pointRadius: 0 },
            { label: 'Drug A Tissue', data: [], borderColor: '#27ae60', borderWidth: 2, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'Drug B Stomach', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Small Intestine', data: [], borderColor: '#2980b9', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Large Intestine', data: [], borderColor: '#1f618d', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Plasma', data: [], borderColor: '#3498db', borderWidth: 4, fill: false, pointRadius: 0 },
            { label: 'Drug B Tissue', data: [], borderColor: '#3498db', borderWidth: 2, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'Drug A GI Target', data: [], borderColor: '#27ae60', borderWidth: 2, borderDash: [10, 3], fill: false, pointRadius: 0 },
            { label: 'Drug A GI Upper', data: [], borderColor: '#27ae60', borderWidth: 1, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'Drug A GI Lower', data: [], borderColor: '#27ae60', borderWidth: 1, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'Drug B GI Target', data: [], borderColor: '#3498db', borderWidth: 2, borderDash: [10, 3], fill: false, pointRadius: 0 },
            { label: 'Drug B GI Upper', data: [], borderColor: '#3498db', borderWidth: 1, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'Drug B GI Lower', data: [], borderColor: '#3498db', borderWidth: 1, borderDash: [3, 3], fill: false, pointRadius: 0 }
        ]},
        options: opts
    });
    
    var effectOpts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: 'Time (hrs)' } },
            y: { title: { display: true, text: 'Effect' } }
        },
        plugins: {
            legend: {
                labels: {
                    usePointStyle: true,
                    pointStyle: 'circle',
                    boxWidth: 8,
                    boxHeight: 8
                }
            }
        }
    };
    
    charts.effects = new Chart(document.getElementById('chart3').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Drug A Effect', data: [], borderColor: '#27ae60', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Drug B Effect', data: [], borderColor: '#3498db', borderWidth: 2, fill: false, pointRadius: 0 },
            { label: 'Combined Effect', data: [], borderColor: '#9b59b6', borderWidth: 4, fill: false, pointRadius: 0 },
            { label: 'Baseline', data: [], borderColor: '#95a5a6', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 },
            { label: 'PD Target Effect', data: [], borderColor: '#e67e22', borderWidth: 2, borderDash: [10, 3], fill: false, pointRadius: 0 },
            { label: 'PD Target Upper', data: [], borderColor: '#e67e22', borderWidth: 1, borderDash: [3, 3], fill: false, pointRadius: 0 },
            { label: 'PD Target Lower', data: [], borderColor: '#e67e22', borderWidth: 1, borderDash: [3, 3], fill: false, pointRadius: 0 }
        ]},
        options: effectOpts
    });
}

function runSim() {
    try {
        var data = simulate();
        if (!data.length) return;
        
        var times = data.map(function(d) { return d.time; });
        var baseline = getVal('baseline');
        
        // Drug A GI targets
        var giTarget1 = getVal('giTargetEffect1');
        var giRangePercent1 = getVal('giTargetRange1') / 100;
        var giTargetUpper1 = giTarget1 * (1 + giRangePercent1);
        var giTargetLower1 = giTarget1 * (1 - giRangePercent1);
        
        // Drug B GI targets
        var giTarget2 = getVal('giTargetEffect2');
        var giRangePercent2 = getVal('giTargetRange2') / 100;
        var giTargetUpper2 = giTarget2 * (1 + giRangePercent2);
        var giTargetLower2 = giTarget2 * (1 - giRangePercent2);
        
        // PD targets
        var pdTarget = getVal('pdTargetEffect');
        var pdRangePercent = getVal('pdTargetRange') / 100;
        var pdTargetUpper = pdTarget * (1 + pdRangePercent);
        var pdTargetLower = pdTarget * (1 - pdRangePercent);
        
        var stats = calculateStats(data);
        var pdAssessment = assessTherapeuticWindow(data, baseline, pdTarget, pdTargetUpper, pdTargetLower);
        var giAssessment1 = assessGIWindow(data, baseline, giTarget1, giTargetUpper1, giTargetLower1, 1);
        var giAssessment2 = assessGIWindow(data, baseline, giTarget2, giTargetUpper2, giTargetLower2, 2);
        
        var allEffects = [];
        data.forEach(function(d) {
            allEffects.push(baseline + d.effect1);
            allEffects.push(baseline + d.effect2);
            allEffects.push(d.combinedEffect);
        });
        allEffects.push(baseline);
        allEffects.push(pdTarget);
        allEffects.push(pdTargetUpper);
        allEffects.push(pdTargetLower);
        
        var minEffect = Math.min.apply(Math, allEffects);
        var maxEffect = Math.max.apply(Math, allEffects);
        var range = maxEffect - minEffect;
        var padding = Math.max(10, range * 0.1);
        
        charts.effects.options.scales.y.min = minEffect - padding;
        charts.effects.options.scales.y.max = maxEffect + padding;
        
        charts.release.data.labels = times;
        charts.release.data.datasets[0].data = data.map(function(d) { return d.drug1.tablet; });
        charts.release.data.datasets[1].data = data.map(function(d) { return d.drug2.tablet; });
        charts.release.data.datasets[2].data = data.map(function(d) { return d.dissolvedDrug1; });
        charts.release.data.datasets[3].data = data.map(function(d) { return d.dissolvedDrug2; });
        charts.release.update();
        
        charts.gi.data.labels = times;
        charts.gi.data.datasets[0].data = data.map(function(d) { return d.drug1.stomach; });
        charts.gi.data.datasets[1].data = data.map(function(d) { return d.drug1.si; });
        charts.gi.data.datasets[2].data = data.map(function(d) { return d.drug1.li; });
        charts.gi.data.datasets[3].data = data.map(function(d) { return d.drug1.plasma; });
        charts.gi.data.datasets[4].data = data.map(function(d) { return d.drug1.tissue; });
        charts.gi.data.datasets[5].data = data.map(function(d) { return d.drug2.stomach; });
        charts.gi.data.datasets[6].data = data.map(function(d) { return d.drug2.si; });
        charts.gi.data.datasets[7].data = data.map(function(d) { return d.drug2.li; });
        charts.gi.data.datasets[8].data = data.map(function(d) { return d.drug2.plasma; });
        charts.gi.data.datasets[9].data = data.map(function(d) { return d.drug2.tissue; });
        
        // Drug A GI target lines
        charts.gi.data.datasets[10].data = times.map(function() { return giTarget1; });
        charts.gi.data.datasets[11].data = times.map(function() { return giTargetUpper1; });
        charts.gi.data.datasets[12].data = times.map(function() { return giTargetLower1; });
        charts.gi.data.datasets[10].hidden = !getCheck('enabled1');
        charts.gi.data.datasets[11].hidden = !getCheck('enabled1');
        charts.gi.data.datasets[12].hidden = !getCheck('enabled1');
        
        // Drug B GI target lines
        charts.gi.data.datasets[13].data = times.map(function() { return giTarget2; });
        charts.gi.data.datasets[14].data = times.map(function() { return giTargetUpper2; });
        charts.gi.data.datasets[15].data = times.map(function() { return giTargetLower2; });
        charts.gi.data.datasets[13].hidden = !getCheck('enabled2');
        charts.gi.data.datasets[14].hidden = !getCheck('enabled2');
        charts.gi.data.datasets[15].hidden = !getCheck('enabled2');
        
        charts.gi.update();
        
        charts.effects.data.labels = times;
        charts.effects.data.datasets[0].data = data.map(function(d) { return baseline + d.effect1; });
        charts.effects.data.datasets[1].data = data.map(function(d) { return baseline + d.effect2; });
        charts.effects.data.datasets[2].data = data.map(function(d) { return d.combinedEffect; });
        charts.effects.data.datasets[3].data = times.map(function() { return baseline; });
        charts.effects.data.datasets[4].data = times.map(function() { return pdTarget; });
        charts.effects.data.datasets[5].data = times.map(function() { return pdTargetUpper; });
        charts.effects.data.datasets[6].data = times.map(function() { return pdTargetLower; });
        charts.effects.update();
        
        document.getElementById('cmax1').textContent = stats.cmax1.toFixed(2);
        document.getElementById('cmax2').textContent = stats.cmax2.toFixed(2);
        document.getElementById('tmax1').textContent = stats.tmax1.toFixed(1);
        document.getElementById('tmax2').textContent = stats.tmax2.toFixed(1);
        document.getElementById('auc1').textContent = stats.auc1.toFixed(1);
        document.getElementById('auc2').textContent = stats.auc2.toFixed(1);
        
        // Update max effect values
        var maxEffect1El = document.getElementById('maxEffect1');
        var maxEffect2El = document.getElementById('maxEffect2');
        var maxEffectEl = document.getElementById('maxEffect');
        
        if (maxEffect1El) maxEffect1El.textContent = stats.maxEffect1.toFixed(1);
        if (maxEffect2El) maxEffect2El.textContent = stats.maxEffect2.toFixed(1);
        if (maxEffectEl) maxEffectEl.textContent = stats.maxEffect.toFixed(1);
        
        // PD Assessment
        var assessmentCard = document.getElementById('assessmentGrade').parentElement;
        var assessmentGrade = document.getElementById('assessmentGrade');
        var assessmentFeedback = document.getElementById('assessmentFeedback');
        
        assessmentGrade.textContent = pdAssessment.grade;
        assessmentFeedback.textContent = pdAssessment.feedback;
        
        assessmentCard.className = 'stat-card assessment ' + (pdAssessment.passed ? 'pass' : 'fail');
        assessmentFeedback.style.backgroundColor = pdAssessment.passed ? '#d4edda' : '#f8d7da';
        assessmentFeedback.style.color = pdAssessment.passed ? '#155724' : '#721c24';
        assessmentFeedback.style.border = '1px solid ' + (pdAssessment.passed ? '#c3e6cb' : '#f5c6cb');
        
        // Drug A GI Assessment
        var giAssessmentCard1 = document.getElementById('giAssessmentGrade1').parentElement;
        var giAssessmentGrade1 = document.getElementById('giAssessmentGrade1');
        var giAssessmentFeedback1 = document.getElementById('giAssessmentFeedback1');
        
        giAssessmentGrade1.textContent = giAssessment1.grade;
        giAssessmentFeedback1.textContent = giAssessment1.feedback;
        
        giAssessmentCard1.className = 'stat-card assessment ' + (giAssessment1.passed ? 'pass' : 'fail');
        giAssessmentFeedback1.style.backgroundColor = giAssessment1.passed ? '#d4edda' : '#f8d7da';
        giAssessmentFeedback1.style.color = giAssessment1.passed ? '#155724' : '#721c24';
        giAssessmentFeedback1.style.border = '1px solid ' + (giAssessment1.passed ? '#c3e6cb' : '#f5c6cb');
        
        // Drug B GI Assessment
        var giAssessmentCard2 = document.getElementById('giAssessmentGrade2').parentElement;
        var giAssessmentGrade2 = document.getElementById('giAssessmentGrade2');
        var giAssessmentFeedback2 = document.getElementById('giAssessmentFeedback2');
        
        giAssessmentGrade2.textContent = giAssessment2.grade;
        giAssessmentFeedback2.textContent = giAssessment2.feedback;
        
        giAssessmentCard2.className = 'stat-card assessment ' + (giAssessment2.passed ? 'pass' : 'fail');
        giAssessmentFeedback2.style.backgroundColor = giAssessment2.passed ? '#d4edda' : '#f8d7da';
        giAssessmentFeedback2.style.color = giAssessment2.passed ? '#155724' : '#721c24';
        giAssessmentFeedback2.style.border = '1px solid ' + (giAssessment2.passed ? '#c3e6cb' : '#f5c6cb');
        
    } catch (error) {
        console.error('Error in runSim:', error);
    }
}

window.onload = function() {
    var controls = ['dose1', 'dose2', 'adminTime1', 'adminTime2', 'interval1', 'interval2', 
                   'numDoses1', 'numDoses2', 'dissolution1', 'dissolution2',
                   'stomachAbs1', 'stomachAbs2', 'siAbs1', 'siAbs2', 'liAbs1', 'liAbs2',
                   'wasteElim1', 'wasteElim2',
                   'stomachTransit1', 'stomachTransit2', 'intestineTransit1', 'intestineTransit2',
                   'distribution1', 'distribution2', 'redistribution1', 'redistribution2',
                   'bioavailability1', 'bioavailability2', 'vd1', 'vd2',
                   'ec501', 'ec502', 'emax1', 'emax2', 'halflife1', 'halflife2',
                   'baseline', 'giTargetEffect1', 'giTargetRange1',
                   'giTargetEffect2', 'giTargetRange2',
                   'pdTargetEffect', 'pdTargetRange', 'simTime', 'interactionFactor'];
    
    controls.forEach(function(id) { updateVal(id); });
    
    // Initialize collapsible sections with proper max-height
    document.querySelectorAll('.collapsible-content').forEach(function(content) {
        content.style.maxHeight = content.scrollHeight + 'px';
    });
    
    setupCharts();
    runSim();
};


var currentDrugSlot = '';

function openDrugPopup(drugSlot) {
    currentDrugSlot = drugSlot;
    document.getElementById('modalTitle').textContent = `Select Drug ${drugSlot}`;
    populateDrugTable();
    document.getElementById('drugModal').style.display = 'block';
}

function closeDrugModal() {
    document.getElementById('drugModal').style.display = 'none';
}

function populateDrugTable() {
    var tbody = document.getElementById('drugTableBody');
    tbody.innerHTML = '';
    
    if (drugData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No drug data loaded. Please load the drug sheet first.</td></tr>';
        return;
    }
    
    drugData.forEach((drug, index) => {
        var row = document.createElement('tr');
        
        // Extract values from your sheet structure
        var drugName = drug['Drug Name'] || drug['Name'] || Object.values(drug)[0] || `Drug ${index + 1}`;
      var ec50 = drug['EC50 (nM)'] || drug['EC50'] || 'N/A';
var emax = drug['Emax'] || 'N/A';
var halflife = drug['Half-life (hrs)'] || drug['Half-life'] || 'N/A';
var bioavailability = drug['Bioavailability'] || 'N/A';
var volumeOfDistribution = drug['Volume of Distribution (L/kg)'] || drug['Volume of Distribution'] || 'N/A';
        // Parse comma-separated values with better handling
var dosesStr = drug['Dose (mg)'] || '50';
var dissolutionStr = drug['Dissolution Rate'] || '0.1';

// Clean and parse doses
var doses = dosesStr.toString()
    .replace(/"/g, '')  // Remove any quotes
    .split(',')
    .map(d => d.trim())
    .filter(d => d && d !== '');

// Clean and parse dissolution rates - only actual sheet values
var dissolutions = dissolutionStr.toString()
    .replace(/"/g, '')
    .split(',')
    .map(d => d.trim())
    .filter(d => d && d !== '');

// Debug output to console
console.log('Drug:', drug['Drug Name'] || 'Unknown');
console.log('Available columns:', Object.keys(drug));
console.log('Dissolution Rate field:', drug['Dissolution Rate']);
console.log('Raw doses string:', dosesStr);
console.log('Parsed doses:', doses);
console.log('Raw dissolution string:', dissolutionStr);
console.log('Parsed dissolutions:', dissolutions);
        
        row.innerHTML = `
    <td style="font-weight: bold;">${drugName}</td>
    <td>${ec50}</td>
    <td>${emax}</td>
    <td>${halflife}</td>
    <td>${bioavailability}</td>
    <td>${volumeOfDistribution}</td>
    <td class="values-list">${doses.join(', ')}</td>
    <td class="values-list">${dissolutions.join(', ')}</td>
    <td>
        <button class="select-drug-btn" onclick="openDrugConfig(${index})">
            Configure
        </button>
    </td>
`;
        
        tbody.appendChild(row);
    });
}

function finalizeDrugSelection() {
    if (!currentDrugData || selectedDose === null || selectedDissolution === null) {
        return;
    }
    
    var drugName = currentDrugData['Drug Name'] || currentDrugData['Name'] || Object.values(currentDrugData)[0];
    var drugNum = currentDrugSlot === 'A' ? '1' : '2';
    
    // Update button text to show selection
    var buttonSpan = document.getElementById(`drug${currentDrugSlot}Selected`);
    buttonSpan.textContent = `${drugName} (${selectedDose}mg, k=${selectedDissolution})`;
    
    // Load all drug parameters from the sheet
    loadDrugParameters(currentDrugData, drugNum);
    
    // Set selected dose and dissolution
    setSliderValue('dose' + drugNum, selectedDose);
    setSliderValue('dissolution' + drugNum, selectedDissolution);
    
    // Enable the drug
    document.getElementById('enabled' + drugNum).checked = true;
    
    // Close modals
    closeDrugConfigModal();
    closeDrugModal();
    
    // Run simulation
    runSim();
}

function loadDrugParameters(drug, drugNum) {
    // Load parameters based on your sheet column names
    if (drug['EC50 (nM)'] || drug['EC50']) {
        setSliderValue('ec50' + drugNum, drug['EC50 (nM)'] || drug['EC50']);
    }
    
    if (drug['Emax']) {
        setSliderValue('emax' + drugNum, drug['Emax']);
    }
    
    if (drug['Bioavailability']) {
        setSliderValue('bioavailability' + drugNum, drug['Bioavailability']);
    }
    
    if (drug['Half-life (hrs)'] || drug['Half-life']) {
        setSliderValue('halflife' + drugNum, drug['Half-life (hrs)'] || drug['Half-life']);
    }
    
    // Load other parameters if they exist in your sheet
    if (drug['Distribution to Tissue']) {
        setSliderValue('distribution' + drugNum, drug['Distribution to Tissue']);
    }
    
    if (drug['Redistribution from Tissue']) {
        setSliderValue('redistribution' + drugNum, drug['Redistribution from Tissue']);
    }
    
    if (drug['Stomach Absorption']) {
        setSliderValue('stomachAbs' + drugNum, drug['Stomach Absorption']);
    }
    
    if (drug['Small Intestine Absorption']) {
        setSliderValue('siAbs' + drugNum, drug['Small Intestine Absorption']);
    }
    
    if (drug['Large Intestine Absorption']) {
        setSliderValue('liAbs' + drugNum, drug['Large Intestine Absorption']);
    }
    
    if (drug['GI Target Effect']) {
        setSliderValue('giTargetEffect' + drugNum, drug['GI Target Effect']);
    }
    
    if (drug['GI Target Range']) {
        setSliderValue('giTargetRange' + drugNum, drug['GI Target Range']);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    var drugModal = document.getElementById('drugModal');
    var configModal = document.getElementById('drugConfigModal');
    var scenarioModal = document.getElementById('scenarioModal');
    
    if (event.target == drugModal) {
        closeDrugModal();
    } else if (event.target == configModal) {
        closeDrugConfigModal();
    } else if (event.target == scenarioModal) {
        closeScenarioModal();
    }
}  

    function openDrugConfig(drugIndex) {
    currentDrugIndex = drugIndex;
    currentDrugData = drugData[drugIndex];
    selectedDose = null;
    selectedDissolution = null;
    
    var drugName = currentDrugData['Drug Name'] || currentDrugData['Name'] || Object.values(currentDrugData)[0] || `Drug ${drugIndex + 1}`;
    document.getElementById('selectedDrugName').textContent = drugName;
    document.getElementById('configModalTitle').textContent = `Configure ${drugName}`;
    
// Parse and populate dose options - only actual sheet values
var dosesStr = currentDrugData['Dose (mg)'] || '50';
var doses = dosesStr.toString()
    .replace(/"/g, '')  // Remove any quotes
    .split(',')
    .map(d => d.trim())
    .filter(d => d && d !== '');
populateOptions('doseOptions', doses, 'dose');

// Parse and populate dissolution options - only actual sheet values
var dissolutionStr = currentDrugData['Dissolution Rate'] || '0.1';

// Enhanced debugging
console.log('=== DISSOLUTION DEBUG ===');
console.log('Raw dissolution string:', JSON.stringify(dissolutionStr));
console.log('String length:', dissolutionStr.length);
console.log('Contains comma?', dissolutionStr.includes(','));
console.log('Character codes:', Array.from(dissolutionStr).map(c => c.charCodeAt(0)));

var dissolutions = dissolutionStr.toString()
    .replace(/"/g, '')  // Remove any quotes
    .replace(/'/g, '')  // Remove single quotes too
    .split(',')
    .map(d => d.trim())
    .filter(d => d && d !== '');

console.log('After processing:', dissolutions);
console.log('Number of dissolution options:', dissolutions.length);
console.log('=== END DEBUG ===');

populateOptions('dissolutionOptions', dissolutions, 'dissolution');

// Debug output
console.log('Config - Raw doses:', dosesStr);
console.log('Config - Parsed doses:', doses);
console.log('Config - Raw dissolution:', dissolutionStr);
console.log('Config - Parsed dissolutions:', dissolutions);

   
    // Reset selection displays
    document.getElementById('selectedDose').textContent = 'None';
    document.getElementById('selectedDissolution').textContent = 'None';
    document.getElementById('chooseDrugBtn').disabled = true;
    
    // Hide drug list modal and show config modal
    document.getElementById('drugModal').style.display = 'none';
    document.getElementById('drugConfigModal').style.display = 'block';
}

function populateOptions(containerId, values, type) {
    var container = document.getElementById(containerId);
    container.innerHTML = '';
    
    values.forEach(value => {
        var button = document.createElement('button');
        button.className = 'option-btn';
        button.textContent = value;
        button.onclick = () => selectOption(type, value, button);
        container.appendChild(button);
    });
}

function selectOption(type, value, buttonElement) {
    // Remove selection from siblings
    var siblings = buttonElement.parentElement.querySelectorAll('.option-btn');
    siblings.forEach(btn => btn.classList.remove('selected'));
    
    // Add selection to clicked button
    buttonElement.classList.add('selected');
    
    // Update selection
    if (type === 'dose') {
        selectedDose = parseFloat(value);
        document.getElementById('selectedDose').textContent = value;
    } else if (type === 'dissolution') {
        selectedDissolution = parseFloat(value);
        document.getElementById('selectedDissolution').textContent = value;
    }
    
    // Enable choose button if both are selected
    updateChooseButton();
}

function updateChooseButton() {
    var chooseBtn = document.getElementById('chooseDrugBtn');
    chooseBtn.disabled = !(selectedDose !== null && selectedDissolution !== null);
}

function closeDrugConfigModal() {
    document.getElementById('drugConfigModal').style.display = 'none';
    // Show the drug list modal again
    document.getElementById('drugModal').style.display = 'block';
}

// Scenario modal functions
function openScenarioModal() {
    var scenarioUrl = document.getElementById('scenarioUrl').value;
    if (!scenarioUrl) {
        alert('No scenario document URL available for this patient.');
        return;
    }
    
    document.getElementById('scenarioModal').style.display = 'block';
    loadScenarioContent(scenarioUrl);
}

function closeScenarioModal() {
    document.getElementById('scenarioModal').style.display = 'none';
}

function loadScenarioContent(url) {
    var contentDiv = document.getElementById('scenarioContent');
    contentDiv.innerHTML = '<div class="scenario-loading">Loading scenario description...</div>';
    
    // Convert Google Doc sharing URL to plain text export URL
    var docId = extractGoogleDocId(url);
    if (!docId) {
        contentDiv.innerHTML = '<div style="color: #e74c3c; text-align: center;">Invalid Google Doc URL format.</div>';
        return;
    }
    
    var exportUrl = `https://docs.google.com/document/d/${docId}/export?format=html`;

fetch(exportUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load document');
        }
        return response.text();
    })
    .then(html => {
        // Clean and display the HTML content
        var cleanedHtml = cleanGoogleDocHtml(html);
        contentDiv.innerHTML = cleanedHtml || 'No content available in this document.';
    })
        .catch(error => {
            console.error('Error loading scenario:', error);
            contentDiv.innerHTML = '<div style="color: #e74c3c; text-align: center;">Error loading scenario description. Please check that the document is publicly accessible.</div>';
        });
}

function extractGoogleDocId(url) {
    // Extract document ID from various Google Doc URL formats
    var patterns = [
        /\/document\/d\/([a-zA-Z0-9-_]+)/,
        /id=([a-zA-Z0-9-_]+)/,
        /^([a-zA-Z0-9-_]+)$/
    ];
    
    for (var i = 0; i < patterns.length; i++) {
        var match = url.match(patterns[i]);
        if (match) {
            return match[1];
        }
    }
    
    return null;
}    


function cleanGoogleDocHtml(html) {
    // Create a temporary div to parse the HTML
    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // Remove unwanted elements (scripts, styles, etc.)
    var unwantedSelectors = ['script', 'style', 'link', 'meta', 'title'];
    unwantedSelectors.forEach(selector => {
        var elements = tempDiv.querySelectorAll(selector);
        elements.forEach(el => el.remove());
    });
    
    // Find the body content or main content area
    var bodyContent = tempDiv.querySelector('body') || tempDiv;
    
    // Clean up inline styles that might interfere with our styling
    var allElements = bodyContent.querySelectorAll('*');
    allElements.forEach(el => {
        // Remove most inline styles but keep some table formatting
        if (el.style) {
            var keepStyles = [];
            if (el.tagName === 'TABLE' || el.tagName === 'TD' || el.tagName === 'TH') {
                // Keep border and padding styles for tables
                if (el.style.border) keepStyles.push('border: ' + el.style.border);
                if (el.style.padding) keepStyles.push('padding: ' + el.style.padding);
                if (el.style.borderCollapse) keepStyles.push('border-collapse: ' + el.style.borderCollapse);
            }
            el.style.cssText = keepStyles.join('; ');
        }
        
        // Remove specific Google Docs classes and IDs
        if (el.className && el.className.includes('c')) {
            el.className = '';
        }
        if (el.id) {
            el.id = '';
        }
    });
    
    return bodyContent.innerHTML;
}
    
    
</script>
</body>
</html>    
